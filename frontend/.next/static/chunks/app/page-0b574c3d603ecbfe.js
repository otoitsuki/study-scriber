(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{4404:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>ew});var s=n(3644),r=n(8475);n(323);var o=n(8851),a=n(2556),i=n(3855);function c(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,i.QP)((0,a.$)(t))}let l=o.forwardRef((e,t)=>{let{className:n,type:r,...o}=e;return(0,s.jsx)("input",{type:r,className:c("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",n),ref:t,...o})});l.displayName="Input";var d=n(2055),u=n(8238);let g=(0,u.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),p=o.forwardRef((e,t)=>{let{className:n,variant:r,size:o,asChild:a=!1,...i}=e,l=a?d.DX:"button";return(0,s.jsx)(l,{className:c(g({variant:r,size:o,className:n})),ref:t,...i})});p.displayName="Button";var h=n(3650),m=n(2611),f=n(4770);let v={session:15e3,notes:8e3,export:3e4,default:1e4},S=e=>{var t,n;return!!("ERR_NETWORK"===e.code||"ECONNABORTED"===e.code||"ECONNRESET"===e.code||e.message.includes("timeout"))||null!==(t=e.response)&&void 0!==t&&!!t.status&&!!(e.response.status>=500)||(null===(n=e.response)||void 0===n?void 0:n.status)===429},w={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2},x=(e,t)=>Math.min(t.baseDelay*Math.pow(t.backoffFactor,e-1),t.maxDelay),y=e=>f.A.create({baseURL:"http://localhost:8000",timeout:e,headers:{"Content-Type":"application/json"}}),b=y(v.session),D=y(v.notes),C=y(v.export),R=y(v.default);async function T(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={...w,...n};for(let n=1;n<=s.maxRetries;n++)try{let s=await e();return n>1&&console.log("✅ [API重試] ".concat(t," 重試成功 (第 ").concat(n," 次嘗試)")),s}catch(a){let e=n===s.maxRetries;if(f.A.isAxiosError(a)){var r,o;if(!S(a))throw console.log("❌ [API重試] ".concat(t," 遇到不可重試錯誤:"),{status:null===(o=a.response)||void 0===o?void 0:o.status,code:a.code,message:a.message}),a;if(e)throw console.error("❌ [API重試] ".concat(t," 重試失敗，已達最大重試次數 (").concat(s.maxRetries,")")),a;let i=x(n,s);console.warn("⚠️ [API重試] ".concat(t," 第 ").concat(n," 次嘗試失敗，").concat(i,"ms 後重試..."),{status:null===(r=a.response)||void 0===r?void 0:r.status,code:a.code,attempt:"".concat(n,"/").concat(s.maxRetries),nextDelay:i}),await new Promise(e=>setTimeout(e,i))}else throw a}throw Error("".concat(t," 重試邏輯異常"))}let k=(e,t)=>{e.interceptors.response.use(e=>{var n;return console.log("\uD83D\uDCE1 [".concat(t,"] API 請求成功:"),{method:null===(n=e.config.method)||void 0===n?void 0:n.toUpperCase(),url:e.config.url,status:e.status,duration:e.headers["x-response-time"]||"unknown"}),e},e=>{var n,s,r,o,a,i,c;return(null===(n=e.response)||void 0===n?void 0:n.status)===404&&(null===(r=e.config)||void 0===r?void 0:null===(s=r.url)||void 0===s?void 0:s.includes("/api/session/active"))||console.error("❌ [".concat(t,"] API 錯誤:"),{method:null===(a=e.config)||void 0===a?void 0:null===(o=a.method)||void 0===o?void 0:o.toUpperCase(),url:null===(i=e.config)||void 0===i?void 0:i.url,status:null===(c=e.response)||void 0===c?void 0:c.status,code:e.code,message:e.message,isRetriable:S(e)}),Promise.reject(e)})};k(b,"Session"),k(D,"Notes"),k(C,"Export"),k(R,"Default");let E={createSession:async e=>T(async()=>(await b.post("/api/session",e)).data,"建立會話 (".concat(e.type,")"),{maxRetries:2}),getActiveSession:async()=>T(async()=>{try{return(await b.get("/api/session/active")).data}catch(t){var e;if(f.A.isAxiosError(t)&&(null===(e=t.response)||void 0===e?void 0:e.status)===404)return null;throw t}},"檢查活躍會話",{maxRetries:3,baseDelay:500}),finishSession:async e=>T(async()=>{await b.patch("/api/session/".concat(e,"/finish"))},"完成會話 (".concat(e,")"),{maxRetries:2}),upgradeToRecording:async e=>T(async()=>(await b.patch("/api/session/".concat(e,"/upgrade"))).data,"升級會話 (".concat(e,")"),{maxRetries:2}),deleteSession:async e=>T(async()=>(await b.delete("/api/session/".concat(e))).data,"刪除會話 (".concat(e,")"),{maxRetries:2})},N={updateNote:async(e,t)=>T(async()=>(await D.put("/api/notes/".concat(e),t)).data,"更新筆記 (".concat(e,")"),{maxRetries:3,baseDelay:500}),getNote:async e=>T(async()=>(await D.get("/api/notes/".concat(e))).data,"獲取筆記 (".concat(e,")"),{maxRetries:3,baseDelay:500})},_=e=>"".concat("ws://localhost:8000").concat(e);class M{connect(){return new Promise((e,t)=>{try{this.ws=new WebSocket(this.url),this.isManualClose=!1,this.ws.onopen=()=>{console.log("✅ WebSocket 連接成功:",this.url),this.reconnectAttempts=0,e()},this.ws.onerror=e=>{console.error("❌ WebSocket 連接錯誤:",e),t(e)},this.ws.onclose=e=>{console.log("\uD83D\uDD0C WebSocket 連接關閉:",e.code,e.reason),!this.isManualClose&&this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,console.log("\uD83D\uDD04 嘗試重新連接 (".concat(this.reconnectAttempts,"/").concat(this.maxReconnectAttempts,")")),setTimeout(()=>{this.connect()},this.reconnectDelay*this.reconnectAttempts))}}catch(e){t(e)}})}disconnect(){this.isManualClose=!0,this.ws&&(this.ws.close(),this.ws=null)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.warn("⚠️ WebSocket 未連接，無法發送資料")}onMessage(e){this.ws&&(this.ws.onmessage=e)}onClose(e){if(this.ws){let t=this.ws.onclose,n=this.ws;this.ws.onclose=s=>{e(s),t&&t.call(n,s)}}}get readyState(){var e,t;return null!==(t=null===(e=this.ws)||void 0===e?void 0:e.readyState)&&void 0!==t?t:WebSocket.CLOSED}get isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}constructor(e){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isManualClose=!1,this.url=e}}class A extends M{uploadAudioChunk(e){if(!this.isConnected){console.warn("⚠️ WebSocket 未連接，無法上傳音檔");return}let t=new ArrayBuffer(4);new DataView(t).setUint32(0,this.sequenceNumber,!0),e.arrayBuffer().then(n=>{let s=new ArrayBuffer(t.byteLength+n.byteLength),r=new Uint8Array(s);r.set(new Uint8Array(t),0),r.set(new Uint8Array(n),t.byteLength),this.send(s),console.log("\uD83D\uDCE4 上傳音檔切片 #".concat(this.sequenceNumber,", 大小: ").concat(e.size," bytes")),this.sequenceNumber++})}onAckMissing(e){this.onMessage(t=>{try{let n=JSON.parse(t.data);switch(n.type){case"ack_missing":n.missing&&Array.isArray(n.missing)?e(n):console.error("❌ 收到的 ack_missing 訊息格式不正確:",n);break;case"ack":console.log("✅ 音檔切片確認:",n.chunk_sequence||"unknown");break;case"heartbeat_ack":console.log("\uD83D\uDC93 音檔上傳心跳確認");break;case"connection_established":console.log("✅ 音檔上傳 WebSocket 連接已建立");break;case"error":console.error("❌ 音檔上傳服務端錯誤:",n.message);break;default:console.warn("⚠️ 收到未知的音檔上傳訊息類型:",n.type)}}catch(e){console.error("❌ 解析音檔上傳服務訊息失敗:",e)}})}resetSequence(){this.sequenceNumber=0}constructor(e){super(_("/ws/upload_audio/".concat(e))),this.sequenceNumber=0}}class j extends M{onMessage(e){super.onMessage(t=>{try{let n=JSON.parse(t.data);e(n)}catch(e){console.error("❌ TranscriptWebSocket 解析訊息失敗:",e)}})}sendJson(e){this.isConnected&&this.send(JSON.stringify(e))}constructor(e){super(_("/ws/transcript_feed/".concat(e)))}}let I={chunkInterval:12e3,mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:128e3},O=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/ogg;codecs=opus","audio/wav"];class L{isSupported(){return"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices&&"MediaRecorder"in window}getSupportedMimeType(){for(let e of O)if(MediaRecorder.isTypeSupported(e))return console.log("\uD83C\uDFA4 使用音訊格式:",e),e;return console.warn("⚠️ 使用預設音訊格式:",I.mimeType),I.mimeType}async initialize(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3}}),console.log("\uD83C\uDFA4 音訊權限已獲取")}catch(t){let e=t instanceof Error?t.message:"無法取得音訊權限";throw this.handleError(Error("音訊初始化失敗: ".concat(e))),t}}async startRecording(){if("recording"!==this.state){if(this.mediaStream||await this.initialize(),!this.mediaStream)throw Error("音訊串流未初始化");try{this.mediaRecorder=new MediaRecorder(this.mediaStream,{mimeType:this.config.mimeType,audioBitsPerSecond:this.config.audioBitsPerSecond}),this.setupMediaRecorderEvents(),this.mediaRecorder.start(this.config.chunkInterval),this.startTime=Date.now(),this.sequence=0,this.setState("recording"),console.log("\uD83C\uDFA4 開始錄音")}catch(t){let e=t instanceof Error?t.message:"錄音啟動失敗";throw this.handleError(Error("錄音啟動失敗: ".concat(e))),t}}}stopRecording(){"recording"===this.state&&(this.mediaRecorder&&this.mediaRecorder.stop(),this.setState("idle"),console.log("\uD83D\uDED1 停止錄音"))}pauseRecording(){"recording"===this.state&&this.mediaRecorder&&(this.mediaRecorder.pause(),this.setState("paused"),console.log("⏸️ 暫停錄音"))}resumeRecording(){"paused"===this.state&&this.mediaRecorder&&(this.mediaRecorder.resume(),this.setState("recording"),console.log("▶️ 恢復錄音"))}cleanup(){this.stopRecording(),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.mediaRecorder=null,console.log("\uD83E\uDDF9 音訊錄製器已清理")}setupMediaRecorderEvents(){this.mediaRecorder&&(this.mediaRecorder.ondataavailable=async e=>{if(e.data&&e.data.size>0){var t;if(e.data.size<50){console.warn("⚠️ 音訊切片 #".concat(this.sequence," 太小，跳過: ").concat(e.data.size," bytes"));return}let n={blob:e.data,timestamp:Date.now(),duration:Date.now()-this.startTime,sequence:this.sequence++};console.log("\uD83C\uDFB5 產生有效音訊切片 #".concat(n.sequence,", 大小: ").concat(n.blob.size," bytes, 類型: ").concat(n.blob.type)),null===(t=this.onChunkCallback)||void 0===t||t.call(this,n)}else console.warn("⚠️ 收到空的音訊切片 #".concat(this.sequence))},this.mediaRecorder.onerror=e=>{let t=e.error||Error("MediaRecorder 錯誤");this.handleError(t)},this.mediaRecorder.onstart=()=>{console.log("\uD83C\uDFA4 MediaRecorder 已啟動")},this.mediaRecorder.onstop=()=>{console.log("\uD83D\uDED1 MediaRecorder 已停止")})}setState(e){var t;this.state=e,null===(t=this.onStateChangeCallback)||void 0===t||t.call(this,e)}handleError(e){var t;console.error("❌ AudioRecorder 錯誤:",e),this.setState("error"),null===(t=this.onErrorCallback)||void 0===t||t.call(this,e)}onChunk(e){this.onChunkCallback=e}onStateChange(e){this.onStateChangeCallback=e}onError(e){this.onErrorCallback=e}get currentState(){return this.state}get isRecording(){return"recording"===this.state}get isPaused(){return"paused"===this.state}get currentConfig(){return{...this.config}}constructor(e={}){if(this.mediaRecorder=null,this.mediaStream=null,this.state="idle",this.sequence=0,this.startTime=0,this.config={...I,...e},!this.isSupported())throw Error("您的瀏覽器不支援音訊錄製功能");this.config.mimeType=this.getSupportedMimeType()}}class W{static getInstance(){return W.instance||(W.instance=new W),W.instance}async connect(e){if(this.connections.has(e)&&this.connectionStates.get(e)){console.log("\uD83D\uDCF1 [TranscriptManager] Session ".concat(e," 已連接，跳過重複連接"));return}try{console.log("\uD83D\uDCF1 [TranscriptManager] 開始連接 session ".concat(e)),await this.disconnect(e),this.reconnectAttempts.set(e,0),await this.establishConnection(e),await this.waitForConnectionReady(e),console.log("✅ [TranscriptManager] Session ".concat(e," 連接並就緒"))}catch(t){throw console.error("❌ [TranscriptManager] Session ".concat(e," 連接失敗:"),t),this.connectionStates.set(e,!1),this.scheduleReconnect(e),t}}async waitForConnectionReady(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return new Promise((n,s)=>{let r=Date.now(),o=()=>{let a=this.connections.get(e),i=this.connectionStates.get(e);console.log("\uD83D\uDD0D [TranscriptManager] 檢查連線就緒狀態:",{sessionId:e,hasWebSocket:!!a,isConnected:!!i,wsReadyState:null==a?void 0:a.readyState,wsIsConnected:(null==a?void 0:a.isConnected)||!1,elapsedTime:Date.now()-r});let c=a&&(a.isConnected||a.readyState===WebSocket.OPEN||window.WebSocket&&1===a.readyState);if(a&&c){!0!==this.connectionStates.get(e)&&(console.log("\uD83D\uDD04 [TranscriptManager] 即時同步連接狀態: ".concat(e," → ").concat(!0)),this.connectionStates.set(e,!0)),console.log("✅ [TranscriptManager] Session ".concat(e," 連線就緒")),n();return}if(a&&!c&&!1!==this.connectionStates.get(e)&&(console.log("\uD83D\uDD04 [TranscriptManager] 即時同步連接狀態: ".concat(e," → ").concat(!1)),this.connectionStates.set(e,!1)),Date.now()-r>t){console.error("⏰ [TranscriptManager] Session ".concat(e," 連線就緒等待超時")),console.error("   最終狀態: ws=".concat(!!a,", isConnected=").concat(!!i,", wsReady=").concat(!!c)),s(Error("連線就緒等待超時 (".concat(t,"ms)")));return}setTimeout(o,100)};o()})}async establishConnection(e){let t=new j(e);t.onMessage(t=>{this.handleMessage(e,t)}),this.setupConnectionHandlers(t,e),await t.connect(),this.connections.set(e,t),this.connectionStates.set(e,!0),this.sendPing(e),this.startHeartbeat(e),console.log("✅ TranscriptManager: Session ".concat(e," 連接成功"))}setupConnectionHandlers(e,t){e.onClose(e=>{console.log("\uD83D\uDD0C TranscriptManager: Session ".concat(t," 連接關閉:"),e.code,e.reason),this.connectionStates.set(t,!1),this.stopHeartbeat(t),1e3!==e.code&&this.scheduleReconnect(t)})}handleMessage(e,t){var n,s,r,o;console.log("\uD83D\uDCE8 [TranscriptManager] 收到訊息:",{sessionId:e,type:t.type,message:t,timestamp:new Date().toISOString(),listenerCount:(null===(n=this.listeners.get(e))||void 0===n?void 0:n.size)||0}),"transcript_segment"===t.type?(console.log("\uD83D\uDCDD [TranscriptManager] 逐字稿片段詳情:",{sessionId:e,text:t.text,textLength:(null===(s=t.text)||void 0===s?void 0:s.length)||0,textPreview:(null===(r=t.text)||void 0===r?void 0:r.substring(0,50))+((null===(o=t.text)||void 0===o?void 0:o.length)>50?"...":""),start_time:t.start_time,end_time:t.end_time,confidence:t.confidence}),this.broadcastToListeners(e,t)):"connection_established"===t.type?console.log("✅ [TranscriptManager] 連接已建立:",{sessionId:e,message:t.message,timestamp:t.timestamp}):"transcript_complete"===t.type?(console.log("\uD83C\uDFAF [TranscriptManager] 轉錄完成:",{sessionId:e,message:t.message,timestamp:t.timestamp}),this.broadcastToListeners(e,t)):"heartbeat_ack"===t.type?console.log("\uD83D\uDC93 [TranscriptManager] 心跳回應:",{sessionId:e,timestamp:t.timestamp}):"pong"===t.type?console.log("\uD83C\uDFD3 [TranscriptManager] Pong 回應:",{sessionId:e,timestamp:t.timestamp}):"waiting"===t.phase?console.log("⏳ [TranscriptManager] 收到 waiting phase:",{sessionId:e,phase:t.phase,timestamp:new Date().toISOString()}):"active"===t.phase?console.log("✅ [TranscriptManager] 收到 active phase，轉錄已開始:",{sessionId:e,phase:t.phase,timestamp:new Date().toISOString()}):"error"===t.type||"transcription_error"===t.type?(console.error("\uD83D\uDEA8 [TranscriptManager] 收到轉錄錯誤:",{sessionId:e,type:t.type,error_type:t.error_type,error_message:t.error_message,details:t.details,timestamp:new Date().toISOString()}),this.broadcastToListeners(e,t)):console.log("\uD83D\uDCE8 [TranscriptManager] 未知訊息類型:",{sessionId:e,type:t.type,fullMessage:t})}broadcastToListeners(e,t){let n=this.listeners.get(e);if(console.log("\uD83D\uDCE1 [TranscriptManager] 廣播訊息給監聽器:",{sessionId:e,messageType:t.type,listenerCount:(null==n?void 0:n.size)||0,hasListeners:!!n}),n){let e=0,s=0;n.forEach(r=>{try{r(t),e++,console.log("✅ [TranscriptManager] 監聽器回調成功 (".concat(e,"/").concat(n.size,")"))}catch(e){s++,console.error("❌ [TranscriptManager] 監聽器回調錯誤 (".concat(s,"/").concat(n.size,"):"),e)}}),console.log("\uD83D\uDCE1 [TranscriptManager] 廣播完成: ".concat(e," 成功, ").concat(s," 失敗"))}else console.warn("⚠️ [TranscriptManager] 沒有找到 session ".concat(e," 的監聽器"))}sendPing(e){let t=this.connections.get(e);t&&t.isConnected&&(t.sendJson({type:"ping"}),console.log("\uD83C\uDFD3 TranscriptManager: 向 session ".concat(e," 發送 ping")))}sendHeartbeat(e){let t=this.syncConnectionState(e),n=this.connections.get(e);if(n&&t)try{n.sendJson({type:"heartbeat",timestamp:Date.now()}),console.log("\uD83D\uDC93 TranscriptManager: 向 session ".concat(e," 發送心跳"))}catch(t){console.error("❌ TranscriptManager: 發送心跳失敗 ".concat(e,":"),t),this.connectionStates.set(e,!1),this.scheduleReconnect(e)}else console.warn("⚠️ TranscriptManager: 心跳檢測到連接斷開 ".concat(e)),this.stopHeartbeat(e),this.connectionStates.set(e,!1),this.scheduleReconnect(e)}startHeartbeat(e){this.stopHeartbeat(e);let t=setInterval(()=>{this.sendHeartbeat(e)},this.heartbeatInterval);this.heartbeatIntervals.set(e,t),console.log("\uD83D\uDC93 TranscriptManager: 為 session ".concat(e," 啟動心跳"))}stopHeartbeat(e){let t=this.heartbeatIntervals.get(e);t&&(clearInterval(t),this.heartbeatIntervals.delete(e),console.log("\uD83D\uDC93 TranscriptManager: 為 session ".concat(e," 停止心跳")))}scheduleReconnect(e){var t;let n=null!==(t=this.reconnectAttempts.get(e))&&void 0!==t?t:0;if(n>=this.maxReconnectAttempts){console.error("❌ TranscriptManager: Session ".concat(e," 重連次數已達上限"));return}this.reconnectAttempts.set(e,n+1);let s=this.reconnectDelay*Math.pow(2,n);console.log("\uD83D\uDD04 TranscriptManager: Session ".concat(e," 將在 ").concat(s,"ms 後重連 (第 ").concat(n+1," 次)")),setTimeout(async()=>{try{await this.establishConnection(e),this.reconnectAttempts.set(e,0)}catch(t){console.error("❌ TranscriptManager: Session ".concat(e," 重連失敗:"),t)}},s)}async disconnect(e){console.log("\uD83D\uDCF1 TranscriptManager: 斷開 session ".concat(e)),this.stopHeartbeat(e);let t=this.connections.get(e);t&&(t.disconnect(),this.connections.delete(e)),this.connectionStates.set(e,!1),this.listeners.delete(e),this.reconnectAttempts.delete(e)}addListener(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),console.log("\uD83D\uDCF1 TranscriptManager: 為 session ".concat(e," 添加監聽器"))}removeListener(e,t){let n=this.listeners.get(e);n&&(n.delete(t),0===n.size&&this.listeners.delete(e)),console.log("\uD83D\uDCF1 TranscriptManager: 為 session ".concat(e," 移除監聽器"))}isConnected(e){var t,n;let s=this.connections.get(e),r=null!==(t=this.connectionStates.get(e))&&void 0!==t&&t,o=!1;return s&&(o=s.isConnected&&(s.readyState===WebSocket.OPEN||window.WebSocket&&1===s.readyState)),console.log("\uD83D\uDD0D [TranscriptManager] 連接狀態檢查:",{sessionId:e,hasWebSocket:!!s,wsReadyState:null==s?void 0:s.readyState,wsIsConnected:null!==(n=null==s?void 0:s.isConnected)&&void 0!==n&&n,stateConnected:r,actualConnected:o,needsSync:r!==o,timestamp:Date.now()}),r!==o&&(console.log("\uD83D\uDD04 [TranscriptManager] 狀態不一致，即時同步: ".concat(e," ").concat(r," → ").concat(o),{previousState:r,newState:o,wsDetails:{isConnected:null==s?void 0:s.isConnected,readyState:null==s?void 0:s.readyState}}),this.connectionStates.set(e,o),r&&!o&&(console.warn("⚠️ [TranscriptManager] 檢測到連接斷開，將觸發重連: ".concat(e)),this.scheduleReconnect(e))),o}syncConnectionState(e){var t;let n=this.connections.get(e),s=null!==(t=this.connectionStates.get(e))&&void 0!==t&&t;if(!n)return!1!==s&&(console.log("\uD83D\uDD04 [TranscriptManager] 同步狀態 (無WebSocket): ".concat(e," → false")),this.connectionStates.set(e,!1)),!1;let r=n.isConnected&&(n.readyState===WebSocket.OPEN||window.WebSocket&&1===n.readyState);return s!==r&&(console.log("\uD83D\uDD04 [TranscriptManager] 同步狀態: ".concat(e," ").concat(s," → ").concat(r)),this.connectionStates.set(e,r)),r}getConnectionCount(){return Array.from(this.connections.values()).filter(e=>e.isConnected).length}async disconnectAll(){console.log("\uD83D\uDCF1 TranscriptManager: 清理所有連接");let e=Array.from(this.connections.keys());await Promise.all(e.map(e=>this.disconnect(e)))}constructor(){this.connections=new Map,this.listeners=new Map,this.connectionStates=new Map,this.heartbeatIntervals=new Map,this.reconnectAttempts=new Map,this.maxReconnectAttempts=5,this.heartbeatInterval=1e4,this.reconnectDelay=2e3,window.transcriptManager=this}}W.instance=null;let P=W.getInstance();function q(){let[e,t]=(0,o.useState)(!1),[n,s]=(0,o.useState)(0),[r,a]=(0,o.useState)([]),[i,c]=(0,o.useState)(!1),[l,d]=(0,o.useState)(null),u=(0,o.useRef)(null),g=(0,o.useRef)(null),p=(0,o.useRef)(null),h=(0,o.useRef)(null),m=(0,o.useRef)(null),f=(0,o.useRef)([]),v=(0,o.useRef)(new Map),S=(0,o.useCallback)(()=>{h.current&&(clearInterval(h.current),h.current=null)},[]),w=(0,o.useCallback)(()=>{m.current&&(clearInterval(m.current),m.current=null)},[]),x=(0,o.useCallback)(e=>{w(),m.current=setInterval(()=>{e.isConnected&&e.send(JSON.stringify({type:"heartbeat",timestamp:Date.now()}))},3e4)},[w]),y=(0,o.useCallback)(()=>{S(),s(0),h.current=setInterval(()=>{s(e=>e+1)},1e3)},[S]),b=(0,o.useCallback)(e=>{var t;if(console.log("\uD83D\uDCDD [useRecording] 收到逐字稿訊息:",{type:e.type,text:e.text,textLength:(null===(t=e.text)||void 0===t?void 0:t.length)||0,start_time:e.start_time,end_time:e.end_time,start_sequence:e.start_sequence,confidence:e.confidence,sessionId:p.current,timestamp:new Date().toISOString()}),"transcript_complete"===e.type||"transcription_complete"===e.message){console.log("✅ [useRecording] 逐字稿轉錄完成，設定 transcriptCompleted=true"),c(!0);return}if("transcript_segment"!==e.type){console.log("⚠️ [useRecording] 跳過非逐字稿片段訊息:",e.type);return}if(!e.text){console.log("⚠️ [useRecording] 跳過空文字逐字稿");return}console.log("\uD83D\uDD04 [useRecording] 開始處理逐字稿片段..."),a(t=>{var n,s,r,o;console.log("\uD83D\uDCCA [useRecording] 合併前狀態:",{existingCount:t.length,newSegmentText:e.text,newSegmentSequence:e.start_sequence,newSegmentTime:e.start_time});let a=null!==(o=null!==(r=e.start_sequence)&&void 0!==r?r:e.timestamp)&&void 0!==o?o:0,i=t.filter(e=>{var t,n;return(null!==(n=null!==(t=e.start_sequence)&&void 0!==t?t:e.timestamp)&&void 0!==n?n:0)!==a}),c=[...i,e].sort((e,t)=>{var n,s,r,o;return(null!==(s=null!==(n=e.start_sequence)&&void 0!==n?n:e.timestamp)&&void 0!==s?s:0)-(null!==(o=null!==(r=t.start_sequence)&&void 0!==r?r:t.timestamp)&&void 0!==o?o:0)});return console.log("\uD83D\uDCCA [useRecording] 合併後狀態:",{newCount:c.length,countChange:c.length-t.length,filteredCount:i.length,isDuplicate:i.length!==t.length,lastSegmentText:(null===(s=c[c.length-1])||void 0===s?void 0:null===(n=s.text)||void 0===n?void 0:n.substring(0,50))+"..."}),console.log("✅ [useRecording] 逐字稿更新完成: ".concat(t.length," → ").concat(c.length," 個片段")),c})},[]),D=(0,o.useCallback)(e=>{console.log("\uD83D\uDCE8 收到 ACK/Missing:",e),e.missing.length>0&&(console.warn("⚠️ 有遺失的音檔切片需要重傳:",e.missing),e.missing.forEach(e=>{var t,n;let s=null!==(t=v.current.get(e))&&void 0!==t?t:0;s<5?(v.current.set(e,s+1),f.current[e]&&(console.log("\uD83D\uDD04 重傳音檔切片 #".concat(e," (第 ").concat(s+1," 次)")),null===(n=u.current)||void 0===n||n.uploadAudioChunk(f.current[e].blob))):console.error("❌ 音檔切片 #".concat(e," 重傳次數已達上限"))}))},[]),C=(0,o.useCallback)(e=>{var t;console.log("\uD83C\uDFB5 收到音檔切片 #".concat(e.sequence,", 大小: ").concat(e.blob.size," bytes")),f.current[e.sequence]=e,(null===(t=u.current)||void 0===t?void 0:t.isConnected)&&u.current.uploadAudioChunk(e.blob)},[]),R=(0,o.useCallback)(async e=>{try{d(null),c(!1),p.current=e,console.log("\uD83C\uDFA4 [useRecording] 開始錄音流程:",{sessionId:e}),console.log("\uD83C\uDFA4 [useRecording] 步驟 1: 初始化音檔錄製器");let n=new L({chunkInterval:12e3,mimeType:"audio/webm;codecs=opus"});g.current=n,f.current=[],v.current.clear(),n.onChunk(C),n.onError(e=>{console.error("❌ AudioRecorder 錯誤:",e),d(e.message)}),console.log("\uD83C\uDFA4 [useRecording] 步驟 2: 初始化音訊權限"),await n.initialize(),console.log("\uD83C\uDFA4 [useRecording] 步驟 3: 建立 WebSocket 連線"),console.log("\uD83D\uDD0C [useRecording] 建立音檔上傳 WebSocket");let s=new A(e);if(await s.connect(),s.onAckMissing(D),u.current=s,console.log("\uD83D\uDD0C [useRecording] 建立逐字稿接收 WebSocket"),await P.connect(e),P.addListener(e,b),console.log("\uD83C\uDFA4 [useRecording] 步驟 4: 驗證連線狀態"),!s.isConnected)throw Error("音檔上傳 WebSocket 連線失敗");if(!P.isConnected(e))throw Error("逐字稿接收 WebSocket 連線失敗");console.log("✅ [useRecording] 所有 WebSocket 連線已建立"),console.log("\uD83C\uDFA4 [useRecording] 步驟 5: 啟動心跳機制"),x(s),console.log("\uD83C\uDFA4 [useRecording] 步驟 6: 開始錄音"),t(!0),console.log("\uD83C\uDFA4 [useRecording] 錄音狀態已設置為 true"),await n.startRecording(),y(),console.log("✅ [useRecording] 錄音開始成功，Session ID:",e)}catch(e){d(e instanceof Error?e.message:"開始錄音失敗"),console.error("❌ [useRecording] 開始錄音失敗:",e),g.current&&g.current.stopRecording(),u.current&&(u.current.disconnect(),u.current=null),p.current&&P.removeListener(p.current,b)}},[C,D,b,y,x]),T=(0,o.useCallback)(()=>{try{g.current&&g.current.stopRecording(),u.current&&(u.current.disconnect(),u.current=null),t(!1),S(),w(),console.log("✅ 錄音停止，等待轉錄完成")}catch(e){console.error("❌ 停止錄音失敗:",e),d("停止錄音時發生錯誤")}},[S,w]),k=(0,o.useCallback)(()=>{a([]),c(!1),console.log("\uD83D\uDD04 逐字稿已清除")},[]);return(0,o.useEffect)(()=>()=>{p.current&&P.removeListener(p.current,b),S(),w(),u.current&&u.current.disconnect(),g.current&&g.current.stopRecording()},[S,w,b]),{isRecording:e,recordingTime:n,transcripts:r,transcriptCompleted:i,error:l,startRecording:R,stopRecording:T,clearTranscripts:k}}function z(){let[e,t]=(0,o.useState)(null),[n,s]=(0,o.useState)(!1),[r,a]=(0,o.useState)(null),i=(0,o.useCallback)(()=>{a(null)},[]),c=(0,o.useCallback)(async()=>{s(!0),i();try{let e=await E.getActiveSession();if(e)return t(e),console.log("✅ 已恢復活躍會話狀態:",e),e;return console.log("ℹ️ 沒有活躍會話，使用預設狀態"),null}catch(e){if(e instanceof Error&&e.message.includes("Network Error"))return console.warn("⚠️ Backend API 連線暫時失敗，將在後續重試:",e.message),null;return a(e instanceof Error?e.message:"檢查活躍會話失敗"),console.error("❌ 檢查活躍會話失敗:",e),null}finally{s(!1)}},[i]),l=(0,o.useCallback)(async(e,n)=>{s(!0),i();try{let s=await E.createSession({title:e,type:"note_only",content:n});return t(s),console.log("✅ 純筆記會話建立成功:",s),s}catch(e){var r,o,c;if(f.A.isAxiosError(e)&&(null===(r=e.response)||void 0===r?void 0:r.status)===409)return a("檢測到活躍會話衝突，請重新整理頁面後再試"),console.error("❌ 會話衝突錯誤 (409):",(null===(c=e.response)||void 0===c?void 0:null===(o=c.data)||void 0===o?void 0:o.detail)||e.message),null;return a(e instanceof Error?e.message:"建立會話失敗"),console.error("❌ 建立純筆記會話失敗:",e),null}finally{s(!1)}},[i]),d=(0,o.useCallback)(async(e,n)=>{s(!0),i();try{let s=await E.createSession({title:e,type:"recording",content:n});return t(s),console.log("✅ 錄音會話建立成功:",s),s}catch(e){var r,o,c;if(f.A.isAxiosError(e)&&(null===(r=e.response)||void 0===r?void 0:r.status)===409)return a("檢測到活躍會話衝突，請重新整理頁面後再試"),console.error("❌ 會話衝突錯誤 (409):",(null===(c=e.response)||void 0===c?void 0:null===(o=c.data)||void 0===o?void 0:o.detail)||e.message),null;return a(e instanceof Error?e.message:"建立錄音會話失敗"),console.error("❌ 建立錄音會話失敗:",e),null}finally{s(!1)}},[i]),u=(0,o.useCallback)(async()=>{if(!e)return a("沒有活躍的會話可以升級"),null;if("recording"===e.type)return console.log("\uD83D\uDD04 會話已經是錄音模式"),e;s(!0),i();try{let n=await E.upgradeToRecording(e.id);return t(n),console.log("✅ 會話升級為錄音模式成功:",n),n}catch(e){return a(e instanceof Error?e.message:"升級會話失敗"),console.error("❌ 升級會話失敗:",e),null}finally{s(!1)}},[e,i]),g=(0,o.useCallback)(async()=>{if(!e){console.log("\uD83D\uDD04 沒有活躍的會話需要完成");return}s(!0),i();try{await E.finishSession(e.id),console.log("✅ 會話完成成功:",e.id),t(e=>e?{...e,status:"completed"}:null)}catch(e){a(e instanceof Error?e.message:"完成會話失敗"),console.error("❌ 完成會話失敗:",e)}finally{s(!1)}},[e,i]),p=(0,o.useCallback)(async()=>{if(!e){console.log("\uD83D\uDD04 沒有活躍的會話需要刪除");return}s(!0),i();try{await E.deleteSession(e.id),console.log("✅ 會話刪除成功:",e.id),t(null)}catch(e){a(e instanceof Error?e.message:"刪除會話失敗"),console.error("❌ 刪除會話失敗:",e)}finally{s(!1)}},[e,i]),h=(0,o.useCallback)(()=>{t(null),a(null),console.log("\uD83D\uDD04 會話已清除")},[]);return(0,o.useMemo)(()=>({currentSession:e,isLoading:n,error:r,createNoteSession:l,createRecordingSession:d,upgradeToRecording:u,finishSession:g,deleteSession:p,clearSession:h,checkActiveSession:c}),[e,n,r,l,d,u,g,p,h,c])}let U="studyscriber_draft",F=0,H=new Map,B=e=>{if(H.has(e))return;let t=setTimeout(()=>{H.delete(e),K({type:"REMOVE_TOAST",toastId:e})},1e6);H.set(e,t)},G=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:n}=t;return n?B(n):e.toasts.forEach(e=>{B(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===n||void 0===n?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},J=[],V={toasts:[]};function K(e){V=G(V,e),J.forEach(e=>{e(V)})}function X(e){let{...t}=e,n=(F=(F+1)%Number.MAX_SAFE_INTEGER).toString(),s=()=>K({type:"DISMISS_TOAST",toastId:n});return K({type:"ADD_TOAST",toast:{...t,id:n,open:!0,onOpenChange:e=>{e||s()}}}),{id:n,dismiss:s,update:e=>K({type:"UPDATE_TOAST",toast:{...e,id:n}})}}let Q=(e,t,n,s)=>{let r;let o=Date.now();switch(console.log("\uD83D\uDD04 [狀態映射] 輸入參數 (詳細時序):",{status:e,type:t,isRecording:n,transcriptsPresent:s,timestamp:o,isoTimestamp:new Date().toISOString(),note:"檢查時序和邏輯流程"}),e){case"draft":r="default",console.log("\uD83D\uDD04 [狀態映射] draft → default (時序正常)");break;case"active":"recording"===t?n?s?(r="recording_active",console.log("\uD83D\uDD04 [狀態映射] ✅ 關鍵轉換: recording_waiting → recording_active (時序成功)",{transcriptsPresent:s,timestamp:o,trigger:"first_transcript_received"})):(r="recording_waiting",console.log("\uD83D\uDD04 [狀態映射] 保持 recording_waiting 狀態 (等待逐字稿)",{transcriptsPresent:s,timestamp:o,waiting:"for_first_transcript"})):(r="default",console.log("\uD83D\uDD04 [狀態映射] recording session 但 isRecording=false → default (時序檢查通過)",{timestamp:o,reason:"recording session inactive"})):(r="default",console.log("\uD83D\uDD04 [狀態映射] active session 但 type != recording → default",{type:t,timestamp:o}));break;case"processing":r="processing",console.log("\uD83D\uDD04 [狀態映射] processing → processing (時序正常)",{timestamp:o});break;case"completed":r="finished",console.log("\uD83D\uDD04 [狀態映射] completed → finished (時序正常)",{timestamp:o});break;case"error":r="default",console.log("\uD83D\uDD04 [狀態映射] error → default (錯誤恢復)",{timestamp:o,recovery:!0});break;default:r="default",console.log("\uD83D\uDD04 [狀態映射] unknown → default (安全回退)",{unknownStatus:e,timestamp:o})}return console.log("\uD83D\uDD04 [狀態映射] 最終結果 (時序追蹤): ".concat(e,"(").concat(t,") → ").concat(r),{inputParams:{status:e,type:t,isRecording:n,transcriptsPresent:s},output:r,timestamp:o,duration:Date.now()-o}),r};var $=n(7714),Y=n(9339);function Z(e){let{onStartRecording:t}=e;return(0,s.jsxs)("div",{className:"h-full flex flex-col items-center justify-center p-6 space-y-6",children:[(0,s.jsxs)(p,{onClick:t,size:"lg",className:"flex items-center gap-3 px-8 py-4 text-base",children:[(0,s.jsx)($.A,{className:"w-5 h-5"}),"Start Recording"]}),(0,s.jsxs)("div",{className:"text-center text-muted-foreground text-sm space-y-1",children:[(0,s.jsxs)("p",{className:"flex items-center justify-center gap-2",children:[(0,s.jsx)(Y.A,{className:"w-4 h-4"}),"或直接開始編寫筆記"]}),(0,s.jsx)("p",{children:"錄音功能隨時可以啟用"})]})]})}var ee=n(1377);let et=o.forwardRef((e,t)=>{let{className:n,children:r,...o}=e;return(0,s.jsxs)(ee.bL,{ref:t,className:c("relative overflow-hidden",n),...o,children:[(0,s.jsx)(ee.LM,{className:"h-full w-full rounded-[inherit]",children:r}),(0,s.jsx)(en,{}),(0,s.jsx)(ee.OK,{})]})});et.displayName=ee.bL.displayName;let en=o.forwardRef((e,t)=>{let{className:n,orientation:r="vertical",...o}=e;return(0,s.jsx)(ee.VM,{ref:t,orientation:r,className:c("flex touch-none select-none transition-colors","vertical"===r&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===r&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",n),...o,children:(0,s.jsx)(ee.lr,{className:"relative flex-1 rounded-full bg-border"})})});en.displayName=ee.VM.displayName;var es=n(6540),er=n(3652),eo=n(6315),ea=n(1632);let ei=(0,u.F)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),ec=o.forwardRef((e,t)=>{let{className:n,variant:r,...o}=e;return(0,s.jsx)("div",{ref:t,role:"alert",className:c(ei({variant:r}),n),...o})});ec.displayName="Alert",o.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,s.jsx)("h5",{ref:t,className:c("mb-1 font-medium leading-none tracking-tight",n),...r})}).displayName="AlertTitle";let el=o.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,s.jsx)("div",{ref:t,className:c("text-sm [&_p]:leading-relaxed",n),...r})});function ed(e){let{recordingTime:t,onStopRecording:n,transcriptEntries:r,error:a}=e,[i,c]=(0,o.useState)(!0),l=(0,o.useCallback)(()=>{c(e=>!e)},[]);return(0,s.jsxs)("div",{className:"h-full flex flex-col",children:[(0,s.jsxs)(et,{className:"flex-1",children:[a&&(0,s.jsxs)(ec,{variant:"destructive",className:"m-4",children:[(0,s.jsx)(es.A,{className:"h-4 w-4"}),(0,s.jsx)(el,{children:a})]}),r.length>0?(0,s.jsx)("div",{className:"p-4 space-y-4",children:r.map((e,t)=>(0,s.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,s.jsx)("span",{className:"text-muted-foreground font-mono",children:e.time}),(0,s.jsx)("span",{className:"flex-1",children:e.text})]},t))}):(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8 text-muted-foreground text-center space-y-2",children:[(0,s.jsxs)("div",{className:"text-sm",children:["Recording… ",(e=>{let t=Math.floor(e/60);return"".concat(t.toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"))})(t)]}),(0,s.jsx)("div",{className:"text-xs",children:a?"轉錄過程中發生錯誤":"等待逐字稿..."})]})]}),(0,s.jsxs)("div",{className:"p-4 border-t border-border flex justify-between items-center",children:[(0,s.jsx)(p,{onClick:l,variant:"ghost",size:"sm",className:"flex items-center gap-2 text-muted-foreground",children:i?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(er.A,{className:"w-4 h-4"}),"Auto-scroll"]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eo.A,{className:"w-4 h-4"}),"Manual"]})}),(0,s.jsxs)(p,{onClick:n,variant:"destructive",size:"sm",className:"flex items-center gap-2",children:[(0,s.jsx)(ea.A,{className:"w-4 h-4"}),"Stop"]})]})]})}function eu(e){let{transcriptEntries:t,onStopRecording:n}=e,r=(0,o.useRef)(null),[a,i]=(0,o.useState)(!0),[c,l]=(0,o.useState)(null),d=(0,o.useCallback)(()=>{if(a&&r.current){let e=r.current.querySelector("[data-radix-scroll-area-viewport]");e&&(e.scrollTop=e.scrollHeight)}},[a]),u=(0,o.useCallback)(e=>{let t=e.target;if(t){let{scrollTop:e,scrollHeight:n,clientHeight:s}=t,r=10>Math.abs(n-s-e);!r&&a?i(!1):r&&!a&&i(!0),c&&clearTimeout(c),l(setTimeout(()=>{a||i(!0)},3e3))}},[a,c]),g=(0,o.useCallback)(()=>i(e=>!e),[]),h=(0,o.useCallback)(e=>{if(e.length<=1)return e;let t=[],n={...e[0]};for(let s=1;s<e.length;s++){let r=e[s];5>=Math.abs(60*parseInt(r.time.split(":")[0])+parseInt(r.time.split(":")[1])-(60*parseInt(n.time.split(":")[0])+parseInt(n.time.split(":")[1])))&&n.text.length+r.text.length<200?n={time:n.time,text:n.text.trim()+" "+r.text.trim()}:(t.push(n),n={...r})}return t.push(n),t},[]);(0,o.useEffect)(()=>{d()},[t,d]),(0,o.useEffect)(()=>{var e;let t=null===(e=r.current)||void 0===e?void 0:e.querySelector("[data-radix-scroll-area-viewport]");if(t)return t.addEventListener("scroll",u),()=>t.removeEventListener("scroll",u)},[u]),(0,o.useEffect)(()=>()=>{c&&clearTimeout(c)},[c]);let m=h(t);return(0,s.jsxs)("div",{className:"h-full flex flex-col",children:[(0,s.jsx)(et,{className:"flex-1",ref:r,children:(0,s.jsx)("div",{className:"p-6 space-y-4",children:m.map((e,t)=>(0,s.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,s.jsx)("span",{className:"text-muted-foreground font-mono text-xs mt-1 min-w-[40px] flex-shrink-0",children:e.time}),(0,s.jsx)("span",{className:"text-foreground leading-relaxed",children:e.text})]},t))})}),(0,s.jsxs)("div",{className:"p-4 border-t border-border flex justify-between items-center",children:[(0,s.jsx)(p,{onClick:g,variant:"ghost",size:"sm",className:"flex items-center gap-2 text-muted-foreground",children:a?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(er.A,{className:"w-4 h-4"}),"Auto-scroll"]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eo.A,{className:"w-4 h-4"}),"Manual"]})}),(0,s.jsxs)(p,{onClick:n,variant:"destructive",size:"sm",className:"flex items-center gap-2",children:[(0,s.jsx)(ea.A,{className:"w-4 h-4"}),"Stop"]})]})]})}function eg(e){let{transcriptEntries:t,recordingTime:n,onStopRecording:r,error:o}=e;return 0===t.length?(0,s.jsx)(ed,{recordingTime:n,onStopRecording:r,transcriptEntries:t,error:o}):(0,s.jsx)(eu,{transcriptEntries:t,onStopRecording:r})}el.displayName="AlertDescription";var ep=n(4171);function eh(){return(0,s.jsxs)("div",{className:"h-full flex flex-col items-center justify-center p-6 space-y-4",children:[(0,s.jsx)(ep.A,{className:"w-8 h-8 animate-spin text-muted-foreground"}),(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-lg font-medium text-foreground",children:"Transcription in progress,"}),(0,s.jsx)("div",{className:"text-lg font-medium text-foreground",children:"please wait."})]})]})}var em=n(5049);function ef(e){let{transcriptEntries:t,onExport:n,onToLatest:r}=e;return(0,s.jsxs)("div",{className:"h-full flex flex-col",children:[(0,s.jsx)(et,{className:"flex-1",children:(0,s.jsx)("div",{className:"p-6 space-y-4",children:t.map((e,t)=>(0,s.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,s.jsx)("span",{className:"text-muted-foreground font-mono text-xs mt-1 min-w-[40px] flex-shrink-0",children:e.time}),(0,s.jsx)("span",{className:"text-foreground leading-relaxed",children:e.text})]},t))})}),(0,s.jsx)("div",{className:"p-4 border-t border-border space-y-2",children:(0,s.jsx)("div",{className:"flex justify-center gap-2",children:r&&(0,s.jsxs)(p,{onClick:r,variant:"ghost",size:"sm",className:"flex items-center gap-2",children:[(0,s.jsx)(em.A,{className:"w-4 h-4"}),"To Latest"]})})})]})}let ev=(0,r.default)(()=>Promise.all([n.e(426),n.e(939),n.e(352)]).then(n.bind(n,7939)),{loadableGenerated:{webpack:()=>[7939]},ssr:!1,loading:()=>(0,s.jsx)("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"載入編輯器中..."})});function eS(){let{appData:e,isLoading:t,error:n,startRecording:r,stopRecording:a,newNote:i,saveLocalDraft:c,session:d,recordingError:u,transcriptError:g,createNoteSession:f,sessionLoading:v}=function(){let[e,t]=(0,o.useState)({state:"default",transcriptEntries:[],editorContent:"",isRecording:!1,recordingTime:0}),[n,s]=(0,o.useState)(!1),[r,a]=(0,o.useState)(null),i=z(),c=q(),l=function(){let[e,t]=(0,o.useState)(""),[n,s]=(0,o.useState)(null),[r,a]=(0,o.useState)(!1),[i,c]=(0,o.useState)(null),l=(0,o.useRef)(null),d=(0,o.useRef)(""),u=(0,o.useRef)(null),g=function(e){let[t,n]=(0,o.useState)({title:"",content:""}),[s,r]=(0,o.useState)(!1),[a,i]=(0,o.useState)(null),c=(0,o.useRef)(null),l=(0,o.useRef)(e);(0,o.useEffect)(()=>{l.current=e},[e]);let d=(0,o.useCallback)(()=>{c.current&&(clearTimeout(c.current),c.current=null)},[]),u=(0,o.useCallback)(()=>{try{let e=localStorage.getItem(U);if(!e)return r(!1),null;let t=JSON.parse(e),s={title:t.title||"",content:t.content||""},o=t.timestamp?new Date(t.timestamp):new Date,a=t.sessionId;if(l.current&&a!==l.current)return console.log("\uD83D\uDCDD 草稿屬於其他會話，不載入"),null;return n(s),r(!!(s.title.trim()||s.content.trim())),i(o),console.log("\uD83D\uDCD6 草稿已從本地載入"),s}catch(e){return console.error("❌ 載入草稿失敗:",e),null}},[]),g=(0,o.useCallback)(e=>{let s=new Date,o={...t,...e};if(!o.title.trim()&&!o.content.trim()){p();return}let a={...o,timestamp:s.toISOString(),sessionId:l.current||null};try{localStorage.setItem(U,JSON.stringify(a)),n(o),r(!0),i(s),console.log("\uD83D\uDCBE 草稿已儲存到本地:",o)}catch(e){console.error("❌ 儲存草稿失敗:",e)}},[t]),p=(0,o.useCallback)(()=>{d();try{localStorage.removeItem(U),n({title:"",content:""}),r(!1),i(null),console.log("\uD83D\uDDD1️ 草稿已清除")}catch(e){console.error("❌ 清除草稿失敗:",e)}},[d]),h=(0,o.useCallback)(e=>!!a&&!!s&&a>e,[a,s]),m=(0,o.useCallback)(e=>{d(),c.current=setTimeout(()=>{g(e)},500)},[g,d]);return(0,o.useEffect)(()=>{u()},[u]),(0,o.useEffect)(()=>()=>{d()},[d]),(0,o.useMemo)(()=>({draft:t,hasDraft:s,lastDraftTime:a,saveDraft:m,loadDraft:u,clearDraft:p,isDraftNewer:h}),[t,s,a,m,u,p,h])}(u.current||void 0),p=(0,o.useCallback)(()=>{l.current&&(clearTimeout(l.current),l.current=null)},[]),h=(0,o.useCallback)(async(e,t)=>{if(t.trim()&&t!==d.current){a(!0),c(null);try{let n={content:t,client_ts:new Date().toISOString()};await N.updateNote(e,n),s(new Date),d.current=t,console.log("✅ 筆記儲存成功")}catch(e){c(e instanceof Error?e.message:"儲存筆記失敗"),console.error("❌ 儲存筆記失敗:",e)}finally{a(!1)}}},[]),m=(0,o.useCallback)(async t=>{p(),await h(t,e)},[e,h,p]),f=(0,o.useCallback)(e=>{t(e),g.saveDraft(e),u.current&&(p(),l.current=setTimeout(()=>{h(u.current,e)},1e4))},[h,p,g]),v=(0,o.useCallback)(async e=>{u.current=e,c(null);try{let n=await N.getNote(e),r=n.content,o=new Date(n.updated_at);g.hasDraft&&g.isDraftNewer(o)?(console.log("⚠️ 發現較新的本地草稿，使用草稿內容"),t(g.draftContent),d.current=g.draftContent):(t(r),d.current=r,s(o),g.clearDraft()),console.log("✅ 筆記載入成功")}catch(n){let e=n instanceof Error?n.message:"載入筆記失敗";c(e),console.error("❌ 載入筆記失敗:",n),(e.includes("404")||e.includes("not found"))&&(g.hasDraft?(console.log("\uD83D\uDCDD 使用本地草稿內容"),t(g.draftContent)):t(""),d.current="",console.log("\uD83D\uDD04 初始化空筆記"))}},[g]),S=(0,o.useCallback)(()=>{p(),t(""),s(null),c(null),d.current="",u.current=null,g.clearDraft(),console.log("\uD83D\uDD04 筆記已清除")},[p,g]),w=(0,o.useCallback)(()=>{let e=g.loadDraft();e&&(t(e),console.log("\uD83D\uDD04 已還原本地草稿"))},[g]);return(0,o.useEffect)(()=>()=>{p()},[p]),(0,o.useMemo)(()=>({noteContent:e,lastSaved:n,isSaving:r,error:i,updateNote:f,saveNote:m,loadNote:v,clearNote:S,hasDraft:g.hasDraft,lastDraftTime:g.lastDraftTime,restoreDraft:w,clearDraft:g.clearDraft}),[e,n,r,i,f,m,v,S,g.hasDraft,g.lastDraftTime,w,g.clearDraft])}(),d=function(){let[e,t]=(0,o.useState)([]),[n,s]=(0,o.useState)(!1),[r,a]=(0,o.useState)(!1),[i,c]=(0,o.useState)(null),[l,d]=(0,o.useState)(!0),u=(0,o.useRef)(null),g=(0,o.useRef)(null),p=(0,o.useCallback)(n=>{var s;if(console.log("\uD83D\uDCDD [useTranscript] 收到逐字稿訊息:",{type:n.type,text:n.text,textLength:(null===(s=n.text)||void 0===s?void 0:s.length)||0,start_time:n.start_time,end_time:n.end_time,confidence:n.confidence,sessionId:g.current,currentTranscriptCount:e.length,timestamp:new Date().toISOString()}),"transcript_complete"===n.type||"transcription_complete"===n.message){console.log("✅ [useTranscript] 逐字稿轉錄完成，設定 isCompleted=true"),a(!0);return}if("error"===n.type||"transcription_error"===n.type){console.error("\uD83D\uDEA8 [useTranscript] 收到轉錄錯誤:",n),c(n.error_message||n.details||"轉錄過程中發生錯誤");return}if("transcript_segment"!==n.type){console.log("⚠️ [useTranscript] 跳過非逐字稿片段訊息:",n.type);return}if(!n.text){console.log("⚠️ [useTranscript] 跳過空文字逐字稿");return}console.log("\uD83D\uDD04 [useTranscript] 開始處理逐字稿片段..."),t(e=>{var t,s;console.log("\uD83D\uDCCA [useTranscript] 合併前狀態:",{existingCount:e.length,newSegmentText:n.text,newSegmentTime:n.start_time});let r=h(e,n);return console.log("\uD83D\uDCCA [useTranscript] 合併後狀態:",{newCount:r.length,countChange:r.length-e.length,lastSegmentText:(null===(s=r[r.length-1])||void 0===s?void 0:null===(t=s.text)||void 0===t?void 0:t.substring(0,50))+"..."}),console.log("✅ [useTranscript] 逐字稿更新完成: ".concat(e.length," → ").concat(r.length," 個片段")),r})},[e.length]),h=(0,o.useCallback)((e,t)=>{if(!t.start_time)return[...e,t];let n=e.length-1,s=e[n];if(!(s&&s.end_time&&1>=Math.abs(t.start_time-s.end_time)))return[...e,t];{let r={...s,text:(s.text||"")+" "+(t.text||""),end_time:t.end_time||s.end_time,end_sequence:t.end_sequence||s.end_sequence};return[...e.slice(0,n),r]}},[]),m=(0,o.useCallback)(()=>{u.current&&l&&(u.current.scrollTop=u.current.scrollHeight)},[l]),f=(0,o.useCallback)(e=>{let t=e.target;if(!t)return;let{scrollTop:n,scrollHeight:s,clientHeight:r}=t,o=s-n-r;o>60?d(!1):o<=10&&d(!0)},[]),v=(0,o.useCallback)(e=>{u.current&&u.current.removeEventListener("scroll",f),u.current=e,e&&e.addEventListener("scroll",f)},[f]),S=(0,o.useCallback)(()=>{d(!0),m()},[m]),w=(0,o.useCallback)(()=>{d(!1)},[]),x=(0,o.useCallback)(async e=>{try{c(null),a(!1),g.current&&P.removeListener(g.current,p),await P.connect(e),P.addListener(e,p),g.current=e,s(P.isConnected(e)),console.log("✅ use-transcript 連接成功，Session ID:",e)}catch(e){c(e instanceof Error?e.message:"連接逐字稿服務失敗"),s(!1),console.error("❌ use-transcript 連接失敗:",e)}},[p]),y=(0,o.useCallback)(()=>{g.current&&(P.removeListener(g.current,p),g.current=null),s(!1),console.log("\uD83D\uDD0C use-transcript 斷開連接")},[p]),b=(0,o.useCallback)(()=>{t([]),a(!1),console.log("\uD83D\uDD04 use-transcript 逐字稿已清除")},[]);return(0,o.useEffect)(()=>{e.length>0&&m()},[e,m]),(0,o.useEffect)(()=>()=>{g.current&&P.removeListener(g.current,p),u.current&&u.current.removeEventListener("scroll",f)},[p,f]),{transcripts:e,isConnected:n,isCompleted:r,error:i,connect:x,disconnect:y,clearTranscripts:b,autoScrollEnabled:l,enableAutoScroll:S,disableAutoScroll:w,scrollToLatest:m,setScrollContainer:v}}(),{toast:u}=function(){let[e,t]=o.useState(V);return o.useEffect(()=>(J.push(t),()=>{let e=J.indexOf(t);e>-1&&J.splice(e,1)}),[e]),{...e,toast:X,dismiss:e=>K({type:"DISMISS_TOAST",toastId:e})}}(),g=(0,o.useRef)("default"),p=(0,o.useRef)(!1),h=(0,o.useRef)({recording:null,transcript:null}),m=(0,o.useCallback)((e,t,n)=>{let s=Date.now();if(!e)return console.log("\uD83D\uDD04 [狀態映射] 無活躍會話 → default",{executionTimestamp:s}),"default";let r=Array.isArray(n)&&n.length>0;console.log("\uD83D\uDD04 [狀態映射] 執行時序檢查:",{sessionId:e.id,sessionStatus:e.status,sessionType:e.type,isRecording:t,transcriptCount:n.length,transcriptsPresent:r,executionTimestamp:s,transcriptsSample:n.slice(0,2).map(e=>{var t;return{text:(null===(t=e.text)||void 0===t?void 0:t.substring(0,30))+"...",start_time:e.start_time,type:e.type}}),note:"時序同步檢查完成"});let o=Q(e.status,e.type,t,r);return console.log("\uD83D\uDD04 [狀態映射] 執行結果:",{input:{sessionStatus:e.status,sessionType:e.type,isRecording:t,transcriptsPresent:r},output:o,executionTimestamp:s,executionDuration:Date.now()-s}),o},[]);(0,o.useEffect)(()=>{let e=i.currentSession,n=Date.now();if(console.log("\uD83D\uDD04 [狀態同步] useEffect 觸發 (時序優化版):",{hasActiveSession:!!e,sessionId:null==e?void 0:e.id,sessionStatus:null==e?void 0:e.status,sessionType:null==e?void 0:e.type,isRecording:c.isRecording,transcriptCount:d.transcripts.length,recordingTranscriptCount:c.transcripts.length,currentAppState:g.current,effectExecutionTime:n,note:"使用最新的時序檢查機制"}),e){var s,r,o;let a=c.transcripts,i=Array.isArray(a)&&a.length>0;console.log("\uD83D\uDD04 [狀態同步] 逐字稿狀態計算 (時序保證):",{recordingTranscriptCount:a.length,transcriptsPresent:i,latestTranscriptTime:null===(s=a[a.length-1])||void 0===s?void 0:s.start_time,latestTranscriptText:(null===(o=a[a.length-1])||void 0===o?void 0:null===(r=o.text)||void 0===r?void 0:r.substring(0,30))+"...",effectExecutionTime:n,note:"已確保時序同步"});let l=m(e,c.isRecording,a);l!==g.current?(console.log("\uD83D\uDD04 [狀態同步] 狀態變化 (時序驗證): ".concat(g.current," → ").concat(l),{previousState:g.current,newState:l,stateChangeTimestamp:Date.now(),executionDuration:Date.now()-n,triggerSource:"session_or_recording_change"}),t(e=>({...e,state:l})),g.current=l):console.log("\uD83D\uDD04 [狀態同步] 狀態無變化，跳過更新",{currentState:l,executionTime:Date.now()-n})}},[i.currentSession,c.isRecording,c.transcripts,m]),(0,o.useEffect)(()=>{let e=!0;return(async()=>{console.log("\uD83D\uDE80 初始化應用狀態..."),s(!0);try{let n=await i.checkActiveSession();if(!e)return;if(n)await l.loadNote(n.id);else{let e=localStorage.getItem("draft_note");e&&(t(t=>({...t,editorContent:e})),console.log("\uD83D\uDCDD 載入本地草稿"))}}catch(n){if(!e)return;if(n instanceof Error&&n.message.includes("Network Error")){console.warn("⚠️ 初始化時 Backend 連線失敗，使用離線模式:",n.message);let e=localStorage.getItem("draft_note");e&&(t(t=>({...t,editorContent:e})),console.log("\uD83D\uDCDD 離線模式：載入本地草稿"))}else console.error("❌ 初始化失敗:",n),a(n instanceof Error?n.message:"初始化失敗")}finally{e&&s(!1)}})(),()=>{e=!1}},[]),(0,o.useEffect)(()=>{t(e=>({...e,isRecording:c.isRecording,recordingTime:c.recordingTime}))},[c.isRecording,c.recordingTime]),(0,o.useEffect)(()=>{t(e=>({...e,editorContent:l.noteContent}))},[l.noteContent]),(0,o.useEffect)(()=>{var n,s;console.log("\uD83D\uDCDD [逐字稿更新] useEffect 觸發:",{recordingTranscriptCount:c.transcripts.length,recordingTranscripts:c.transcripts,currentState:e.state,isRecording:e.isRecording,note:"統一使用 recording.transcripts，避免雙重管理"});let r=c.transcripts.map(e=>{var t,n;let s=null!==(t=e.start_time)&&void 0!==t?t:0,r=Math.floor(s/60),o=Math.floor(s%60),a="".concat(r.toString().padStart(2,"0"),":").concat(o.toString().padStart(2,"0"));return console.log("\uD83D\uDCDD [逐字稿轉換] 單個片段:",{text:e.text,timeStr:a,startTime:s,type:e.type}),{time:a,text:null!==(n=e.text)&&void 0!==n?n:""}});console.log("\uD83D\uDCDD [逐字稿更新] 轉換完成:",{entriesCount:r.length,entries:r,firstEntry:(null===(s=r[0])||void 0===s?void 0:null===(n=s.text)||void 0===n?void 0:n.substring(0,30))+"...",appDataBefore:e.transcriptEntries}),t(e=>(console.log("\uD83D\uDCDD [逐字稿更新] setAppData 執行:",{prevTranscriptEntries:e.transcriptEntries,newTranscriptEntries:r,isChanged:e.transcriptEntries!==r}),{...e,transcriptEntries:r}))},[c.transcripts]),(0,o.useEffect)(()=>{let e=d.isCompleted,n=p.current;e&&!n&&"processing"===g.current&&(console.log("\uD83D\uDD04 [轉錄完成] 轉錄完成，轉為 finished 狀態"),t(e=>{let t="finished";return g.current=t,{...e,state:t}}),i.currentSession&&i.finishSession().catch(console.error)),p.current=e},[d.isCompleted,i.currentSession,i.finishSession]),(0,o.useEffect)(()=>{let e=c.error,n=d.error,s=h.current;if(e!==s.recording||n!==s.transcript){if(e||n){var r;console.log("\uD83D\uDEA8 [錯誤處理] 檢測到錯誤:",{recordingError:e,transcriptError:n,currentState:g.current,sessionId:null===(r=i.currentSession)||void 0===r?void 0:r.id});let s=g.current;("recording_waiting"===s||"recording_active"===s)&&(console.log("\uD83D\uDEA8 [錯誤處理] 錄音狀態錯誤，停止錄音並回到預設狀態"),c.stopRecording(),d.disconnect(),t(e=>(g.current="default",{...e,state:"default"})),u({title:"錄音錯誤",description:e||n||"錄音或轉錄過程中發生錯誤",variant:"destructive"})),"processing"===s&&(console.log("\uD83D\uDEA8 [錯誤處理] 處理狀態錯誤，回到預設狀態"),t(e=>(g.current="default",{...e,state:"default"})),u({title:"處理錯誤",description:n||e||"處理轉錄過程中發生錯誤",variant:"destructive"}))}h.current={recording:e,transcript:n}}},[c.error,d.error,i.currentSession,c,d,u]);let f=(0,o.useCallback)(async e=>{s(!0),a(null);try{let t=await i.createNoteSession(e);t&&(await l.loadNote(t.id),localStorage.removeItem("draft_note"),console.log("✅ 純筆記會話建立成功"),u({title:"筆記會話已建立",description:'會話 "'.concat(e,'" 建立成功')}))}catch(t){if(t instanceof Error&&t.message.includes("檢測到活躍會話衝突")){console.error("\uD83C\uDFA4 startRecording: 會話衝突錯誤:",t.message),a("偵測到會話衝突，請重新整理頁面後再試"),u({title:"會話衝突",description:"目前已有活躍會話，請重新整理頁面後再試，或等待當前會話結束",variant:"destructive"});return}let e=t instanceof Error?t.message:"開始錄音失敗";console.error("\uD83C\uDFA4 startRecording: 流程中發生錯誤:",e),a(e),u({title:"錄音失敗",description:e,variant:"destructive"})}finally{s(!1),console.log("\uD83C\uDFA4 startRecording: 流程結束")}},[i,c,d,e.editorContent,u]),v=(0,o.useCallback)(async t=>{s(!0),a(null);try{let n=await i.createRecordingSession(t,e.editorContent);n&&(await l.loadNote(n.id),localStorage.removeItem("draft_note"),console.log("✅ 錄音會話建立成功"),u({title:"錄音會話已建立",description:'會話 "'.concat(t,'" 建立成功')}))}catch(t){if(t instanceof Error&&t.message.includes("檢測到活躍會話衝突")){console.error("\uD83C\uDFA4 createRecordingSession: 會話衝突錯誤:",t.message),a("偵測到會話衝突，請重新整理頁面後再試"),u({title:"會話衝突",description:"目前已有活躍會話，請重新整理頁面後再試，或等待當前會話結束",variant:"destructive"});return}let e=t instanceof Error?t.message:"建立錄音會話失敗";a(e),console.error("❌ 建立錄音會話失敗:",t),u({title:"建立失敗",description:e,variant:"destructive"})}finally{s(!1)}},[i,l,u,e.editorContent]),S=(0,o.useCallback)(async t=>{console.log("\uD83C\uDFA4 startRecording: 流程開始"),s(!0);try{var n;console.log("\uD83C\uDFA4 startRecording: 檢查活躍會話狀態");let s=await i.checkActiveSession(),r=s||i.currentSession;if(console.log("\uD83C\uDFA4 startRecording: 會話狀態檢查結果:",{latestActiveSession:null==s?void 0:s.id,currentSession:null===(n=i.currentSession)||void 0===n?void 0:n.id,finalSessionToUse:null==r?void 0:r.id}),s&&!i.currentSession&&console.log("\uD83C\uDFA4 startRecording: 檢測到活躍會話，同步前端狀態"),r){if("note_only"===r.type){console.log("\uD83C\uDFA4 startRecording: 偵測到 note_only session，進行升級");let e=await i.upgradeToRecording();if(!e)throw console.error("\uD83C\uDFA4 startRecording: 升級 session 失敗，回傳值為 null"),Error("無法升級會話");console.log("\uD83C\uDFA4 startRecording: Session 升級成功:",e),r=e}else"recording"===r.type&&console.log("\uD83C\uDFA4 startRecording: 使用現有的錄音會話:",r.id)}else{console.log("\uD83C\uDFA4 startRecording: 沒有 session，建立新的錄音 session");let n=await i.createRecordingSession(t,e.editorContent);if(!n)throw console.error("\uD83C\uDFA4 startRecording: 建立 session 失敗，回傳值為 null"),Error("無法建立新的錄音會話");console.log("\uD83C\uDFA4 startRecording: Session 建立成功:",n),r=n,localStorage.removeItem("draft_note")}console.log("\uD83C\uDFA4 startRecording: 準備呼叫 recording.startRecording"),await c.startRecording(r.id),console.log("\uD83C\uDFA4 startRecording: recording.startRecording 呼叫完畢"),console.log("\uD83C\uDFA4 startRecording: 跳過 transcript.connect，避免雙重監聽器"),console.log("\uD83C\uDFA4 startRecording: 逐字稿將由 useRecording hook 統一管理"),u({title:"錄音開始"})}catch(t){if(t instanceof Error&&t.message.includes("檢測到活躍會話衝突")){console.error("\uD83C\uDFA4 startRecording: 會話衝突錯誤:",t.message),a("偵測到會話衝突，請重新整理頁面後再試"),u({title:"會話衝突",description:"目前已有活躍會話，請重新整理頁面後再試，或等待當前會話結束",variant:"destructive"});return}let e=t instanceof Error?t.message:"開始錄音失敗";console.error("\uD83C\uDFA4 startRecording: 流程中發生錯誤:",e),a(e),u({title:"錄音失敗",description:e,variant:"destructive"})}finally{s(!1),console.log("\uD83C\uDFA4 startRecording: 流程結束")}},[i,c,d,e.editorContent,u]),w=(0,o.useCallback)(async()=>{s(!0),a(null);try{await i.upgradeToRecording()&&(console.log("✅ 會話升級為錄音模式成功"),u({title:"升級成功",description:"會話已升級為錄音模式"}))}catch(t){let e=t instanceof Error?t.message:"升級會話失敗";a(e),console.error("❌ 升級會話失敗:",t),u({title:"升級失敗",description:e,variant:"destructive"})}finally{s(!1)}},[i,u]),x=(0,o.useCallback)(async()=>{s(!0),a(null);try{await c.stopRecording(),d.disconnect(),t(e=>({...e,state:"processing"})),console.log("✅ 錄音停止，開始處理逐字稿"),u({title:"處理中",description:"正在處理錄音內容，請稍候..."})}catch(t){let e=t instanceof Error?t.message:"停止錄音失敗";a(e),console.error("❌ 停止錄音失敗:",t),u({title:"停止失敗",description:e,variant:"destructive"})}finally{s(!1)}},[c,u]),y=(0,o.useCallback)(async()=>{s(!0),a(null);try{await i.finishSession(),console.log("✅ 會話完成"),u({title:"會話完成",description:"您可以匯出筆記或開始新的筆記"})}catch(t){let e=t instanceof Error?t.message:"完成會話失敗";a(e),console.error("❌ 完成會話失敗:",t),u({title:"完成失敗",description:e,variant:"destructive"})}finally{s(!1)}},[i,u]),b=(0,o.useCallback)(async()=>{s(!0),a(null);try{i.currentSession&&(console.log("\uD83D\uDDD1️ 刪除當前活躍會話:",i.currentSession.id),await i.deleteSession(),console.log("✅ 會話刪除成功")),t({state:"default",transcriptEntries:[],editorContent:"",isRecording:!1,recordingTime:0}),c.clearTranscripts(),d.clearTranscripts(),l.clearNote(),localStorage.removeItem("draft_note"),console.log("\uD83D\uDD04 已開始新筆記"),u({title:"新筆記",description:"已清空內容，可以開始新的筆記"})}catch(t){let e=t instanceof Error?t.message:"開始新筆記失敗";a(e),console.error("❌ 開始新筆記失敗:",t),u({title:"操作失敗",description:e,variant:"destructive"})}finally{s(!1)}},[i,c,d,l,u]);return{appData:e,isLoading:n,error:r,createNoteSession:f,createRecordingSession:v,upgradeToRecording:w,finishSession:y,newNote:b,startRecording:S,stopRecording:x,saveLocalDraft:(0,o.useCallback)(e=>{!i.currentSession&&e.trim()&&localStorage.setItem("draft_note",e)},[i.currentSession]),session:i.currentSession,sessionLoading:i.isLoading,sessionError:i.error,recordingError:c.error,transcriptConnected:d.isConnected,transcriptError:d.error,transcriptAutoScroll:d.autoScrollEnabled,enableAutoScroll:d.enableAutoScroll,disableAutoScroll:d.disableAutoScroll,scrollToLatest:d.scrollToLatest}}(),[S,w]=(0,o.useState)("");console.log("[DEBUG] appData.state:",e.state),console.log("[DEBUG] appData.isRecording:",e.isRecording),d?console.log("[DEBUG] session.status:",d.status,"session.type:",d.type):console.log("[DEBUG] session: null"),window.appData=e;let x=q();window.recordingHook=x;let y=z();window.sessionHook=y,(0,o.useEffect)(()=>{console.log("\uD83D\uDCF1 StudyScriber: appData 更新:",{state:e.state,isRecording:e.isRecording,recordingTime:e.recordingTime,transcriptEntries:e.transcriptEntries,editorContent:e.editorContent,session:d,sessionLoading:v,recordingError:u,transcriptError:g})},[e,d,v,u,g]);let b=(0,o.useMemo)(()=>({spellChecker:!1,placeholder:"Start writing your notes...",status:!1,toolbar:["bold","italic","strikethrough","|","heading-1","heading-2","heading-3","|","quote","unordered-list","ordered-list","|","link","image","table","|","preview","side-by-side","fullscreen"],autofocus:!0,tabSize:2}),[]);return(0,s.jsxs)("div",{className:"h-screen bg-background flex flex-col",suppressHydrationWarning:!0,children:[(0,s.jsxs)("div",{className:"bg-background border-b border-border px-6 flex-shrink-0 w-full h-20 flex justify-between items-center",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold text-foreground",children:"Study Scriber"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[("default"===e.state&&!!d||"recording_waiting"===e.state||"recording_active"===e.state||"finished"===e.state)&&(0,s.jsxs)(p,{variant:"outline",onClick:i,size:"sm",className:"px-4 h-8 flex items-center gap-2",children:[(0,s.jsx)(h.A,{className:"w-4 h-4"}),"New note"]}),"finished"===e.state&&(0,s.jsxs)(p,{onClick:()=>console.log("Export functionality"),size:"sm",className:"px-4 h-8 flex items-center gap-2",children:[(0,s.jsx)(m.A,{className:"w-4 h-4"}),"Export"]})]})]}),(0,s.jsxs)("div",{className:"flex h-[calc(100vh-80px)]",suppressHydrationWarning:!0,children:[(0,s.jsx)("div",{className:"flex-1 bg-background border-r border-border h-full",children:(0,s.jsxs)("div",{className:"h-full p-6 flex flex-col gap-4",children:[(0,s.jsx)(l,{placeholder:"請輸入標題...",className:"text-lg font-semibold",value:S,onChange:e=>w(e.target.value),disabled:"processing"===e.state||"finished"===e.state||e.isRecording}),(0,s.jsx)("div",{className:"h-full editor-container flex-grow",children:(0,s.jsx)(ev,{options:b,value:e.editorContent,onChange:c})})]})}),(0,s.jsx)("div",{className:"w-80 bg-background flex-shrink-0 h-full",children:(()=>{switch(e.state){case"default":return(0,s.jsx)(Z,{onStartRecording:()=>{console.log("\uD83D\uDCF1 StudyScriber: 準備調用 startRecording，標題:",S),r(S)}});case"recording_active":case"recording_waiting":return(0,s.jsx)(eg,{transcriptEntries:e.transcriptEntries,recordingTime:e.recordingTime,onStopRecording:a,error:u||g||null});case"processing":return(0,s.jsx)(eh,{});case"finished":return(0,s.jsx)(ef,{transcriptEntries:e.transcriptEntries,onExport:()=>{console.log("Export functionality not implemented yet")},onToLatest:()=>{console.log("To Latest functionality not implemented yet")}});default:return(0,s.jsx)(Z,{onStartRecording:()=>{console.log("\uD83D\uDCF1 StudyScriber: 準備調用 startRecording (default)，標題:",S),r(S)}})}})()})]})]})}function ew(){return(0,s.jsx)(eS,{})}window.debugTranscript=()=>{var e;let t={type:"transcript_segment",text:"測試逐字稿內容 - 如果看到這個表示前端可以正常處理",start_time:0,end_time:12,start_sequence:0,confidence:.95},n=window.appData,s=(null==n?void 0:null===(e=n.session)||void 0===e?void 0:e.id)||"861f8cee-1f57-476c-8819-0ffe9ec084c8";console.log("\uD83D\uDD0D 測試逐字稿接收，Session ID:",s);let r=window.transcriptManager;if(r){let e=r.listeners.get(s);e&&e.size>0?(console.log("\uD83D\uDCE1 找到 ".concat(e.size," 個監聽器，開始廣播測試訊息")),e.forEach(e=>{try{e(t),console.log("✅ 測試訊息已發送")}catch(e){console.error("❌ 發送測試訊息失敗:",e)}})):console.error("❌ 沒有找到監聽器，請確認 WebSocket 已連接")}else console.error("❌ TranscriptManager 未初始化")},window.debugState=()=>{var e,t,n,s;let r=window.appData;console.log("\uD83D\uDD0D 完整應用狀態診斷："),console.log("1. AppData:",r),console.log("2. Session:",null==r?void 0:r.session),console.log("3. 錄音狀態:",{isRecording:null==r?void 0:r.isRecording,recordingTime:null==r?void 0:r.recordingTime,state:null==r?void 0:r.state}),console.log("4. 逐字稿:",{transcriptEntries:null==r?void 0:r.transcriptEntries,count:(null==r?void 0:null===(e=r.transcriptEntries)||void 0===e?void 0:e.length)||0});let o=window.transcriptManager;o&&(console.log("5. TranscriptManager:"),console.log("   - 連接數:",o.getConnectionCount()),console.log("   - 連接Map:",o.connections),console.log("   - 監聽器Map:",o.listeners)),console.log("6. 狀態映射條件:"),console.log("   - hasSession:",!!(null==r?void 0:r.session)),console.log("   - sessionStatus:",null==r?void 0:null===(t=r.session)||void 0===t?void 0:t.status),console.log("   - sessionType:",null==r?void 0:null===(n=r.session)||void 0===n?void 0:n.type),console.log("   - isRecording:",null==r?void 0:r.isRecording),console.log("   - transcriptCount:",(null==r?void 0:null===(s=r.transcriptEntries)||void 0===s?void 0:s.length)||0)},window.watchTranscripts=()=>{let e="861f8cee-1f57-476c-8819-0ffe9ec084c8",t=e=>{console.log("\uD83C\uDFAF [測試監聽器] 收到訊息:",{type:e.type,text:e.text,time:new Date().toISOString()})},n=window.transcriptManager;return n?(n.addListener(e,t),console.log("✅ 測試監聽器已添加，等待逐字稿訊息..."),()=>{n.removeListener(e,t),console.log("❌ 測試監聽器已移除")}):(console.error("❌ TranscriptManager 未初始化"),()=>{})},window.pushTranscript=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=window.appData;if(!n){console.error("❌ appData 未定義");return}let s=Math.floor(t/60),r=Math.floor(t%60),o={time:"".concat(s.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0")),text:e},a=n.transcriptEntries||[],i=[...a,o];console.log("\uD83D\uDCDD 手動推送逐字稿:",o),console.log("\uD83D\uDCCA 更新前:",a.length,"條"),console.log("\uD83D\uDCCA 更新後:",i.length,"條"),n.transcriptEntries=i,"recording_waiting"===n.state&&i.length>0&&(n.state="recording_active",console.log("✅ 狀態更新: recording_waiting → recording_active")),window.location.reload()},window.diagnose=()=>{var e,t,n,s,r;console.log("\uD83D\uDD0D ========== 診斷開始 ==========");let o=window.appData;console.log("\uD83D\uDCCA [1] appData 狀態:",{state:null==o?void 0:o.state,isRecording:null==o?void 0:o.isRecording,transcriptEntries:(null==o?void 0:null===(e=o.transcriptEntries)||void 0===e?void 0:e.length)||0,session:null==o?void 0:o.session});let a=window.recordingHook;a?console.log("\uD83C\uDFA4 [2] recording hook 狀態:",{isRecording:a.isRecording,transcriptsCount:(null===(r=a.transcripts)||void 0===r?void 0:r.length)||0,transcripts:a.transcripts}):console.error("❌ [2] recording hook 未找到");let i=window.sessionHook;i?console.log("\uD83D\uDD10 [2.5] session hook 狀態:",{currentSession:i.currentSession,isLoading:i.isLoading,error:i.error}):console.error("❌ [2.5] session hook 未找到");let c=window.transcriptManager,l=(null==o?void 0:null===(t=o.session)||void 0===t?void 0:t.id)||(null==i?void 0:null===(n=i.currentSession)||void 0===n?void 0:n.id);if(c&&l?console.log("\uD83D\uDCAC [3] TranscriptManager 狀態:",{isConnected:c.isConnected(l),listeners:c.listeners.size,websocket:c.websocket?"存在":"不存在",sessionId:l}):console.error("❌ [3] session ID 未定義 或 TranscriptManager 未找到",{manager:!!c,sessionId:l}),null==c?void 0:c.websocket){let e=c.websocket;console.log("\uD83D\uDD0C [4] WebSocket 詳情:",{readyState:e.readyState,readyStateText:["CONNECTING","OPEN","CLOSING","CLOSED"][e.readyState],url:e.url,bufferedAmount:e.bufferedAmount,protocol:e.protocol})}else console.error("❌ [4] WebSocket 未建立");console.log("\uD83D\uDCBE [5] localStorage 內容:",{draft_note:(null===(s=localStorage.getItem("draft_note"))||void 0===s?void 0:s.substring(0,100))+"...",hasOtherSessionKeys:Object.keys(localStorage).filter(e=>e.includes("session")).length>0}),console.log("\uD83E\uDDEA [6] 測試 WebSocket 連接...");let d=l||"23f6bbfe-a846-44db-ba1b-2751adafe0bc";console.log("\uD83E\uDDEA 測試 URL:","ws://localhost:8000/ws/transcript_feed/".concat(d)),console.log("\uD83D\uDD0D [7] appData 完整內容:",o),console.log("\uD83D\uDD0D ========== 診斷結束 ==========")},window.forceUpdate=()=>{console.log("\uD83D\uDD04 強制 React 重新渲染...");let e=window.appData;if(e){let t=e.recordingTime;e.recordingTime=t+.1,setTimeout(()=>{e.recordingTime=t,console.log("✅ 強制更新完成")},100)}console.log("如果UI還是沒有更新，將在3秒後重新載入頁面..."),setTimeout(()=>{confirm("UI 沒有更新，是否重新載入頁面？")&&window.location.reload()},3e3)}},8443:(e,t,n)=>{Promise.resolve().then(n.bind(n,4404))}},e=>{var t=t=>e(e.s=t);e.O(0,[294,228,647,303,358],()=>t(8443)),_N_E=e.O()}]);