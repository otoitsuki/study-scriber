(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1913:(e,t,s)=>{Promise.resolve().then(s.bind(s,4546))},4546:(e,t,s)=>{"use strict";s.d(t,{default:()=>et});var n=s(3644),r=s(8475);s(323);var o=s(8851),a=s(2556),i=s(3855);function c(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,i.QP)((0,a.$)(t))}let l=o.forwardRef((e,t)=>{let{className:s,type:r,...o}=e;return(0,n.jsx)("input",{type:r,className:c("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:t,...o})});l.displayName="Input";var u=s(2055);let d=(0,s(8238).F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),g=o.forwardRef((e,t)=>{let{className:s,variant:r,size:o,asChild:a=!1,...i}=e,l=a?u.DX:"button";return(0,n.jsx)(l,{className:c(d({variant:r,size:o,className:s})),ref:t,...i})});g.displayName="Button";var h=s(3650),p=s(2611),m=s(4770);let f=m.A.create({baseURL:"http://localhost:8000",timeout:1e4,headers:{"Content-Type":"application/json"}});f.interceptors.response.use(e=>e,e=>{var t,s,n,r;return(null===(t=e.response)||void 0===t?void 0:t.status)===404&&(null===(n=e.config)||void 0===n?void 0:null===(s=n.url)||void 0===s?void 0:s.includes("/api/session/active"))||console.error("API Error:",(null===(r=e.response)||void 0===r?void 0:r.data)||e.message),Promise.reject(e)});let v={createSession:async e=>(await f.post("/api/session",e)).data,async getActiveSession(){for(let t=1;t<=3;t++)try{return(await f.get("/api/session/active")).data}catch(s){var e;if(m.A.isAxiosError(s)&&(null===(e=s.response)||void 0===e?void 0:e.status)===404)return null;if(m.A.isAxiosError(s)&&"ERR_NETWORK"===s.code&&t<3){console.warn("⚠️ 網路連線失敗 (嘗試 ".concat(t,"/").concat(3,")，").concat(1e3,"ms 後重試...")),await new Promise(e=>setTimeout(e,1e3));continue}throw s}return null},async finishSession(e){await f.patch("/api/session/".concat(e,"/finish"))},upgradeToRecording:async e=>(await f.patch("/api/session/".concat(e,"/upgrade"))).data,deleteSession:async e=>(await f.delete("/api/session/".concat(e))).data},b={updateNote:async(e,t)=>(await f.put("/api/notes/".concat(e),t)).data,getNote:async e=>(await f.get("/api/notes/".concat(e))).data},x=e=>"".concat("ws://localhost:8000").concat(e);class S{connect(){return new Promise((e,t)=>{try{this.ws=new WebSocket(this.url),this.isManualClose=!1,this.ws.onopen=()=>{console.log("✅ WebSocket 連接成功:",this.url),this.reconnectAttempts=0,e()},this.ws.onerror=e=>{console.error("❌ WebSocket 連接錯誤:",e),t(e)},this.ws.onclose=e=>{console.log("\uD83D\uDD0C WebSocket 連接關閉:",e.code,e.reason),!this.isManualClose&&this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,console.log("\uD83D\uDD04 嘗試重新連接 (".concat(this.reconnectAttempts,"/").concat(this.maxReconnectAttempts,")")),setTimeout(()=>{this.connect()},this.reconnectDelay*this.reconnectAttempts))}}catch(e){t(e)}})}disconnect(){this.isManualClose=!0,this.ws&&(this.ws.close(),this.ws=null)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.warn("⚠️ WebSocket 未連接，無法發送資料")}onMessage(e){this.ws&&(this.ws.onmessage=e)}onClose(e){if(this.ws){let t=this.ws.onclose,s=this.ws;this.ws.onclose=n=>{e(n),t&&t.call(s,n)}}}get readyState(){var e,t;return null!==(t=null===(e=this.ws)||void 0===e?void 0:e.readyState)&&void 0!==t?t:WebSocket.CLOSED}get isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}constructor(e){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isManualClose=!1,this.url=e}}class y extends S{uploadAudioChunk(e){if(!this.isConnected){console.warn("⚠️ WebSocket 未連接，無法上傳音檔");return}let t=new ArrayBuffer(4);new DataView(t).setUint32(0,this.sequenceNumber,!0),e.arrayBuffer().then(s=>{let n=new ArrayBuffer(t.byteLength+s.byteLength),r=new Uint8Array(n);r.set(new Uint8Array(t),0),r.set(new Uint8Array(s),t.byteLength),this.send(n),console.log("\uD83D\uDCE4 上傳音檔切片 #".concat(this.sequenceNumber,", 大小: ").concat(e.size," bytes")),this.sequenceNumber++})}onAckMissing(e){this.onMessage(t=>{try{let s=JSON.parse(t.data);switch(s.type){case"ack_missing":s.missing&&Array.isArray(s.missing)?e(s):console.error("❌ 收到的 ack_missing 訊息格式不正確:",s);break;case"ack":console.log("✅ 音檔切片確認:",s.chunk_sequence||"unknown");break;case"heartbeat_ack":console.log("\uD83D\uDC93 音檔上傳心跳確認");break;case"connection_established":console.log("✅ 音檔上傳 WebSocket 連接已建立");break;case"error":console.error("❌ 音檔上傳服務端錯誤:",s.message);break;default:console.warn("⚠️ 收到未知的音檔上傳訊息類型:",s.type)}}catch(e){console.error("❌ 解析音檔上傳服務訊息失敗:",e)}})}resetSequence(){this.sequenceNumber=0}constructor(e){super(x("/ws/upload_audio/".concat(e))),this.sequenceNumber=0}}class w extends S{onMessage(e){super.onMessage(t=>{try{let s=JSON.parse(t.data);e(s)}catch(e){console.error("❌ TranscriptWebSocket 解析訊息失敗:",e)}})}sendJson(e){this.isConnected&&this.send(JSON.stringify(e))}constructor(e){super(x("/ws/transcript_feed/".concat(e)))}}let C={chunkInterval:12e3,mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:128e3},R=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/ogg;codecs=opus","audio/wav"];class k{isSupported(){return"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices&&"MediaRecorder"in window}getSupportedMimeType(){for(let e of R)if(MediaRecorder.isTypeSupported(e))return console.log("\uD83C\uDFA4 使用音訊格式:",e),e;return console.warn("⚠️ 使用預設音訊格式:",C.mimeType),C.mimeType}async initialize(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3}}),console.log("\uD83C\uDFA4 音訊權限已獲取")}catch(t){let e=t instanceof Error?t.message:"無法取得音訊權限";throw this.handleError(Error("音訊初始化失敗: ".concat(e))),t}}async startRecording(){if("recording"!==this.state){if(this.mediaStream||await this.initialize(),!this.mediaStream)throw Error("音訊串流未初始化");try{this.mediaRecorder=new MediaRecorder(this.mediaStream,{mimeType:this.config.mimeType,audioBitsPerSecond:this.config.audioBitsPerSecond}),this.setupMediaRecorderEvents(),this.mediaRecorder.start(this.config.chunkInterval),this.startTime=Date.now(),this.sequence=0,this.setState("recording"),console.log("\uD83C\uDFA4 開始錄音")}catch(t){let e=t instanceof Error?t.message:"錄音啟動失敗";throw this.handleError(Error("錄音啟動失敗: ".concat(e))),t}}}stopRecording(){"recording"===this.state&&(this.mediaRecorder&&this.mediaRecorder.stop(),this.setState("idle"),console.log("\uD83D\uDED1 停止錄音"))}pauseRecording(){"recording"===this.state&&this.mediaRecorder&&(this.mediaRecorder.pause(),this.setState("paused"),console.log("⏸️ 暫停錄音"))}resumeRecording(){"paused"===this.state&&this.mediaRecorder&&(this.mediaRecorder.resume(),this.setState("recording"),console.log("▶️ 恢復錄音"))}cleanup(){this.stopRecording(),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.mediaRecorder=null,console.log("\uD83E\uDDF9 音訊錄製器已清理")}setupMediaRecorderEvents(){this.mediaRecorder&&(this.mediaRecorder.ondataavailable=async e=>{if(e.data&&e.data.size>0){var t;if(e.data.size<50){console.warn("⚠️ 音訊切片 #".concat(this.sequence," 太小，跳過: ").concat(e.data.size," bytes"));return}let s={blob:e.data,timestamp:Date.now(),duration:Date.now()-this.startTime,sequence:this.sequence++};console.log("\uD83C\uDFB5 產生有效音訊切片 #".concat(s.sequence,", 大小: ").concat(s.blob.size," bytes, 類型: ").concat(s.blob.type)),null===(t=this.onChunkCallback)||void 0===t||t.call(this,s)}else console.warn("⚠️ 收到空的音訊切片 #".concat(this.sequence))},this.mediaRecorder.onerror=e=>{let t=e.error||Error("MediaRecorder 錯誤");this.handleError(t)},this.mediaRecorder.onstart=()=>{console.log("\uD83C\uDFA4 MediaRecorder 已啟動")},this.mediaRecorder.onstop=()=>{console.log("\uD83D\uDED1 MediaRecorder 已停止")})}setState(e){var t;this.state=e,null===(t=this.onStateChangeCallback)||void 0===t||t.call(this,e)}handleError(e){var t;console.error("❌ AudioRecorder 錯誤:",e),this.setState("error"),null===(t=this.onErrorCallback)||void 0===t||t.call(this,e)}onChunk(e){this.onChunkCallback=e}onStateChange(e){this.onStateChangeCallback=e}onError(e){this.onErrorCallback=e}get currentState(){return this.state}get isRecording(){return"recording"===this.state}get isPaused(){return"paused"===this.state}get currentConfig(){return{...this.config}}constructor(e={}){if(this.mediaRecorder=null,this.mediaStream=null,this.state="idle",this.sequence=0,this.startTime=0,this.config={...C,...e},!this.isSupported())throw Error("您的瀏覽器不支援音訊錄製功能");this.config.mimeType=this.getSupportedMimeType()}}class T{static getInstance(){return T.instance||(T.instance=new T),T.instance}async connect(e){if(this.connections.has(e)&&this.connectionStates.get(e)){console.log("\uD83D\uDCF1 [TranscriptManager] Session ".concat(e," 已連接，跳過重複連接"));return}try{console.log("\uD83D\uDCF1 [TranscriptManager] 開始連接 session ".concat(e)),await this.disconnect(e),this.reconnectAttempts.set(e,0),await this.establishConnection(e),await this.waitForConnectionReady(e),console.log("✅ [TranscriptManager] Session ".concat(e," 連接並就緒"))}catch(t){throw console.error("❌ [TranscriptManager] Session ".concat(e," 連接失敗:"),t),this.connectionStates.set(e,!1),this.scheduleReconnect(e),t}}async waitForConnectionReady(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return new Promise((s,n)=>{let r=Date.now(),o=()=>{let a=this.connections.get(e),i=this.connectionStates.get(e);console.log("\uD83D\uDD0D [TranscriptManager] 檢查連線就緒狀態:",{sessionId:e,hasWebSocket:!!a,isConnected:!!i,wsReadyState:null==a?void 0:a.readyState,wsIsConnected:(null==a?void 0:a.isConnected)||!1,elapsedTime:Date.now()-r});let c=a&&(a.isConnected||a.readyState===WebSocket.OPEN||window.WebSocket&&1===a.readyState);if(a&&i&&c){console.log("✅ [TranscriptManager] Session ".concat(e," 連線就緒")),s();return}if(Date.now()-r>t){console.error("⏰ [TranscriptManager] Session ".concat(e," 連線就緒等待超時")),console.error("   最終狀態: ws=".concat(!!a,", isConnected=").concat(!!i,", wsReady=").concat(!!c)),n(Error("連線就緒等待超時 (".concat(t,"ms)")));return}setTimeout(o,100)};o()})}async establishConnection(e){let t=new w(e);t.onMessage(t=>{this.handleMessage(e,t)}),this.setupConnectionHandlers(t,e),await t.connect(),this.connections.set(e,t),this.connectionStates.set(e,!0),this.sendPing(e),this.startHeartbeat(e),console.log("✅ TranscriptManager: Session ".concat(e," 連接成功"))}setupConnectionHandlers(e,t){e.onClose(e=>{console.log("\uD83D\uDD0C TranscriptManager: Session ".concat(t," 連接關閉:"),e.code,e.reason),this.connectionStates.set(t,!1),this.stopHeartbeat(t),1e3!==e.code&&this.scheduleReconnect(t)})}handleMessage(e,t){var s,n,r,o;console.log("\uD83D\uDCE8 [TranscriptManager] 收到訊息:",{sessionId:e,type:t.type,message:t,timestamp:new Date().toISOString(),listenerCount:(null===(s=this.listeners.get(e))||void 0===s?void 0:s.size)||0}),"transcript_segment"===t.type?(console.log("\uD83D\uDCDD [TranscriptManager] 逐字稿片段詳情:",{sessionId:e,text:t.text,textLength:(null===(n=t.text)||void 0===n?void 0:n.length)||0,textPreview:(null===(r=t.text)||void 0===r?void 0:r.substring(0,50))+((null===(o=t.text)||void 0===o?void 0:o.length)>50?"...":""),start_time:t.start_time,end_time:t.end_time,confidence:t.confidence}),this.broadcastToListeners(e,t)):"connection_established"===t.type?console.log("✅ [TranscriptManager] 連接已建立:",{sessionId:e,message:t.message,timestamp:t.timestamp}):"transcript_complete"===t.type?(console.log("\uD83C\uDFAF [TranscriptManager] 轉錄完成:",{sessionId:e,message:t.message,timestamp:t.timestamp}),this.broadcastToListeners(e,t)):"heartbeat_ack"===t.type?console.log("\uD83D\uDC93 [TranscriptManager] 心跳回應:",{sessionId:e,timestamp:t.timestamp}):"pong"===t.type?console.log("\uD83C\uDFD3 [TranscriptManager] Pong 回應:",{sessionId:e,timestamp:t.timestamp}):"waiting"===t.phase?console.log("⏳ [TranscriptManager] 收到 waiting phase:",{sessionId:e,phase:t.phase,timestamp:new Date().toISOString()}):"active"===t.phase?console.log("✅ [TranscriptManager] 收到 active phase，轉錄已開始:",{sessionId:e,phase:t.phase,timestamp:new Date().toISOString()}):"error"===t.type||"transcription_error"===t.type?(console.error("\uD83D\uDEA8 [TranscriptManager] 收到轉錄錯誤:",{sessionId:e,type:t.type,error_type:t.error_type,error_message:t.error_message,details:t.details,timestamp:new Date().toISOString()}),this.broadcastToListeners(e,t)):console.log("\uD83D\uDCE8 [TranscriptManager] 未知訊息類型:",{sessionId:e,type:t.type,fullMessage:t})}broadcastToListeners(e,t){let s=this.listeners.get(e);if(console.log("\uD83D\uDCE1 [TranscriptManager] 廣播訊息給監聽器:",{sessionId:e,messageType:t.type,listenerCount:(null==s?void 0:s.size)||0,hasListeners:!!s}),s){let e=0,n=0;s.forEach(r=>{try{r(t),e++,console.log("✅ [TranscriptManager] 監聽器回調成功 (".concat(e,"/").concat(s.size,")"))}catch(e){n++,console.error("❌ [TranscriptManager] 監聽器回調錯誤 (".concat(n,"/").concat(s.size,"):"),e)}}),console.log("\uD83D\uDCE1 [TranscriptManager] 廣播完成: ".concat(e," 成功, ").concat(n," 失敗"))}else console.warn("⚠️ [TranscriptManager] 沒有找到 session ".concat(e," 的監聽器"))}sendPing(e){let t=this.connections.get(e);t&&t.isConnected&&(t.sendJson({type:"ping"}),console.log("\uD83C\uDFD3 TranscriptManager: 向 session ".concat(e," 發送 ping")))}sendHeartbeat(e){let t=this.connections.get(e);t&&t.isConnected?(t.sendJson({type:"heartbeat",timestamp:Date.now()}),console.log("\uD83D\uDC93 TranscriptManager: 向 session ".concat(e," 發送心跳"))):(this.stopHeartbeat(e),this.connectionStates.set(e,!1),this.scheduleReconnect(e))}startHeartbeat(e){this.stopHeartbeat(e);let t=setInterval(()=>{this.sendHeartbeat(e)},this.heartbeatInterval);this.heartbeatIntervals.set(e,t),console.log("\uD83D\uDC93 TranscriptManager: 為 session ".concat(e," 啟動心跳"))}stopHeartbeat(e){let t=this.heartbeatIntervals.get(e);t&&(clearInterval(t),this.heartbeatIntervals.delete(e),console.log("\uD83D\uDC93 TranscriptManager: 為 session ".concat(e," 停止心跳")))}scheduleReconnect(e){var t;let s=null!==(t=this.reconnectAttempts.get(e))&&void 0!==t?t:0;if(s>=this.maxReconnectAttempts){console.error("❌ TranscriptManager: Session ".concat(e," 重連次數已達上限"));return}this.reconnectAttempts.set(e,s+1);let n=this.reconnectDelay*Math.pow(2,s);console.log("\uD83D\uDD04 TranscriptManager: Session ".concat(e," 將在 ").concat(n,"ms 後重連 (第 ").concat(s+1," 次)")),setTimeout(async()=>{try{await this.establishConnection(e),this.reconnectAttempts.set(e,0)}catch(t){console.error("❌ TranscriptManager: Session ".concat(e," 重連失敗:"),t)}},n)}async disconnect(e){console.log("\uD83D\uDCF1 TranscriptManager: 斷開 session ".concat(e)),this.stopHeartbeat(e);let t=this.connections.get(e);t&&(t.disconnect(),this.connections.delete(e)),this.connectionStates.set(e,!1),this.listeners.delete(e),this.reconnectAttempts.delete(e)}addListener(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),console.log("\uD83D\uDCF1 TranscriptManager: 為 session ".concat(e," 添加監聽器"))}removeListener(e,t){let s=this.listeners.get(e);s&&(s.delete(t),0===s.size&&this.listeners.delete(e)),console.log("\uD83D\uDCF1 TranscriptManager: 為 session ".concat(e," 移除監聽器"))}isConnected(e){var t,s;let n=this.connections.get(e),r=null!==(t=this.connectionStates.get(e))&&void 0!==t&&t,o=null!==(s=null==n?void 0:n.isConnected)&&void 0!==s&&s;return r!==o?(this.connectionStates.set(e,o),o):r}getConnectionCount(){return Array.from(this.connections.values()).filter(e=>e.isConnected).length}async disconnectAll(){console.log("\uD83D\uDCF1 TranscriptManager: 清理所有連接");let e=Array.from(this.connections.keys());await Promise.all(e.map(e=>this.disconnect(e)))}constructor(){this.connections=new Map,this.listeners=new Map,this.connectionStates=new Map,this.heartbeatIntervals=new Map,this.reconnectAttempts=new Map,this.maxReconnectAttempts=5,this.heartbeatInterval=1e4,this.reconnectDelay=2e3,window.transcriptManager=this}}T.instance=null;let D=T.getInstance(),E="studyscriber_draft",N=0,_=new Map,j=e=>{if(_.has(e))return;let t=setTimeout(()=>{_.delete(e),L({type:"REMOVE_TOAST",toastId:e})},1e6);_.set(e,t)},M=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:s}=t;return s?j(s):e.toasts.forEach(e=>{j(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===s||void 0===s?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},A=[],I={toasts:[]};function L(e){I=M(I,e),A.forEach(e=>{e(I)})}function O(e){let{...t}=e,s=(N=(N+1)%Number.MAX_SAFE_INTEGER).toString(),n=()=>L({type:"DISMISS_TOAST",toastId:s});return L({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:e=>{e||n()}}}),{id:s,dismiss:n,update:e=>L({type:"UPDATE_TOAST",toast:{...e,id:s}})}}let q=(e,t,s,n)=>{let r;switch(console.log("\uD83D\uDD04 [狀態映射] 輸入參數:",{status:e,type:t,isRecording:s,transcriptsPresent:n,timestamp:new Date().toISOString()}),e){case"draft":default:r="default";break;case"active":"recording"===t?s?(r=n?"recording_active":"recording_waiting",console.log("\uD83D\uDD04 [狀態映射] recording session + isRecording=true，transcriptsPresent=".concat(n," → ").concat(r))):(r="default",console.log("\uD83D\uDD04 [狀態映射] recording session 但 isRecording=false，回到 default")):r="default";break;case"processing":r="processing";break;case"completed":r="finished";break;case"error":r="default",console.log("\uD83D\uDD04 [狀態映射] 檢測到錯誤狀態，轉換到 default")}return console.log("\uD83D\uDD04 [狀態映射] 最終結果: ".concat(e,"(").concat(t,") → ").concat(r)),r};var z=s(7714),P=s(9339);function W(e){let{onStartRecording:t}=e;return(0,n.jsxs)("div",{className:"h-full flex flex-col items-center justify-center p-6 space-y-6",children:[(0,n.jsxs)(g,{onClick:t,size:"lg",className:"flex items-center gap-3 px-8 py-4 text-base",children:[(0,n.jsx)(z.A,{className:"w-5 h-5"}),"Start Recording"]}),(0,n.jsxs)("div",{className:"text-center text-muted-foreground text-sm space-y-1",children:[(0,n.jsxs)("p",{className:"flex items-center justify-center gap-2",children:[(0,n.jsx)(P.A,{className:"w-4 h-4"}),"或直接開始編寫筆記"]}),(0,n.jsx)("p",{children:"錄音功能隨時可以啟用"})]})]})}var F=s(1377);let B=o.forwardRef((e,t)=>{let{className:s,children:r,...o}=e;return(0,n.jsxs)(F.bL,{ref:t,className:c("relative overflow-hidden",s),...o,children:[(0,n.jsx)(F.LM,{className:"h-full w-full rounded-[inherit]",children:r}),(0,n.jsx)(H,{}),(0,n.jsx)(F.OK,{})]})});B.displayName=F.bL.displayName;let H=o.forwardRef((e,t)=>{let{className:s,orientation:r="vertical",...o}=e;return(0,n.jsx)(F.VM,{ref:t,orientation:r,className:c("flex touch-none select-none transition-colors","vertical"===r&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===r&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...o,children:(0,n.jsx)(F.lr,{className:"relative flex-1 rounded-full bg-border"})})});H.displayName=F.VM.displayName;var U=s(3652),J=s(6315),G=s(1632);function V(e){let{recordingTime:t,onStopRecording:s}=e,[r,a]=(0,o.useState)(!0),i=(0,o.useCallback)(()=>{a(e=>!e)},[]);return(0,n.jsxs)("div",{className:"h-full flex flex-col",children:[(0,n.jsx)(B,{className:"flex-1",children:(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8 text-muted-foreground text-center space-y-2",children:[(0,n.jsxs)("div",{className:"text-sm",children:["Recording… ",(e=>{let t=Math.floor(e/60);return"".concat(t.toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"))})(t)]}),(0,n.jsx)("div",{className:"text-xs",children:"Transcript will appear here"})]})}),(0,n.jsxs)("div",{className:"p-4 border-t border-border flex justify-between items-center",children:[(0,n.jsx)(g,{onClick:i,variant:"ghost",size:"sm",className:"flex items-center gap-2 text-muted-foreground",children:r?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(U.A,{className:"w-4 h-4"}),"Auto-scroll"]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(J.A,{className:"w-4 h-4"}),"Manual"]})}),(0,n.jsxs)(g,{onClick:s,variant:"destructive",size:"sm",className:"flex items-center gap-2",children:[(0,n.jsx)(G.A,{className:"w-4 h-4"}),"Stop"]})]})]})}function K(e){let{transcriptEntries:t,onStopRecording:s}=e,r=(0,o.useRef)(null),[a,i]=(0,o.useState)(!0),[c,l]=(0,o.useState)(null),u=(0,o.useCallback)(()=>{if(a&&r.current){let e=r.current.querySelector("[data-radix-scroll-area-viewport]");e&&(e.scrollTop=e.scrollHeight)}},[a]),d=(0,o.useCallback)(e=>{let t=e.target;if(t){let{scrollTop:e,scrollHeight:s,clientHeight:n}=t,r=10>Math.abs(s-n-e);!r&&a?i(!1):r&&!a&&i(!0),c&&clearTimeout(c),l(setTimeout(()=>{a||i(!0)},3e3))}},[a,c]),h=(0,o.useCallback)(()=>i(e=>!e),[]),p=(0,o.useCallback)(e=>{if(e.length<=1)return e;let t=[],s={...e[0]};for(let n=1;n<e.length;n++){let r=e[n];5>=Math.abs(60*parseInt(r.time.split(":")[0])+parseInt(r.time.split(":")[1])-(60*parseInt(s.time.split(":")[0])+parseInt(s.time.split(":")[1])))&&s.text.length+r.text.length<200?s={time:s.time,text:s.text.trim()+" "+r.text.trim()}:(t.push(s),s={...r})}return t.push(s),t},[]);(0,o.useEffect)(()=>{u()},[t,u]),(0,o.useEffect)(()=>{var e;let t=null===(e=r.current)||void 0===e?void 0:e.querySelector("[data-radix-scroll-area-viewport]");if(t)return t.addEventListener("scroll",d),()=>t.removeEventListener("scroll",d)},[d]),(0,o.useEffect)(()=>()=>{c&&clearTimeout(c)},[c]);let m=p(t);return(0,n.jsxs)("div",{className:"h-full flex flex-col",children:[(0,n.jsx)(B,{className:"flex-1",ref:r,children:(0,n.jsx)("div",{className:"p-6 space-y-4",children:m.map((e,t)=>(0,n.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,n.jsx)("span",{className:"text-muted-foreground font-mono text-xs mt-1 min-w-[40px] flex-shrink-0",children:e.time}),(0,n.jsx)("span",{className:"text-foreground leading-relaxed",children:e.text})]},t))})}),(0,n.jsxs)("div",{className:"p-4 border-t border-border flex justify-between items-center",children:[(0,n.jsx)(g,{onClick:h,variant:"ghost",size:"sm",className:"flex items-center gap-2 text-muted-foreground",children:a?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(U.A,{className:"w-4 h-4"}),"Auto-scroll"]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(J.A,{className:"w-4 h-4"}),"Manual"]})}),(0,n.jsxs)(g,{onClick:s,variant:"destructive",size:"sm",className:"flex items-center gap-2",children:[(0,n.jsx)(G.A,{className:"w-4 h-4"}),"Stop"]})]})]})}function X(e){let{transcriptEntries:t,recordingTime:s,onStopRecording:r}=e;return 0===t.length?(0,n.jsx)(V,{recordingTime:s,onStopRecording:r}):(0,n.jsx)(K,{transcriptEntries:t,onStopRecording:r})}var Q=s(4171);function $(){return(0,n.jsxs)("div",{className:"h-full flex flex-col items-center justify-center p-6 space-y-4",children:[(0,n.jsx)(Q.A,{className:"w-8 h-8 animate-spin text-muted-foreground"}),(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"text-lg font-medium text-foreground",children:"Transcription in progress,"}),(0,n.jsx)("div",{className:"text-lg font-medium text-foreground",children:"please wait."})]})]})}var Y=s(5049);function Z(e){let{transcriptEntries:t,onExport:s,onToLatest:r}=e;return(0,n.jsxs)("div",{className:"h-full flex flex-col",children:[(0,n.jsx)(B,{className:"flex-1",children:(0,n.jsx)("div",{className:"p-6 space-y-4",children:t.map((e,t)=>(0,n.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,n.jsx)("span",{className:"text-muted-foreground font-mono text-xs mt-1 min-w-[40px] flex-shrink-0",children:e.time}),(0,n.jsx)("span",{className:"text-foreground leading-relaxed",children:e.text})]},t))})}),(0,n.jsx)("div",{className:"p-4 border-t border-border space-y-2",children:(0,n.jsx)("div",{className:"flex justify-center gap-2",children:r&&(0,n.jsxs)(g,{onClick:r,variant:"ghost",size:"sm",className:"flex items-center gap-2",children:[(0,n.jsx)(Y.A,{className:"w-4 h-4"}),"To Latest"]})})})]})}let ee=(0,r.default)(()=>Promise.all([s.e(426),s.e(939),s.e(352)]).then(s.bind(s,7939)),{loadableGenerated:{webpack:()=>[7939]},ssr:!1,loading:()=>(0,n.jsx)("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"載入編輯器中..."})});function et(){let{appData:e,isLoading:t,error:s,startRecording:r,stopRecording:a,newNote:i,saveLocalDraft:c,session:u}=function(){let[e,t]=(0,o.useState)({state:"default",transcriptEntries:[],editorContent:"",isRecording:!1,recordingTime:0}),[s,n]=(0,o.useState)(!1),[r,a]=(0,o.useState)(null),i=function(){let[e,t]=(0,o.useState)(null),[s,n]=(0,o.useState)(!1),[r,a]=(0,o.useState)(null),i=(0,o.useCallback)(()=>{a(null)},[]),c=(0,o.useCallback)(async()=>{n(!0),i();try{let e=await v.getActiveSession();if(e)return t(e),console.log("✅ 已恢復活躍會話狀態:",e),e;return console.log("ℹ️ 沒有活躍會話，使用預設狀態"),null}catch(e){if(e instanceof Error&&e.message.includes("Network Error"))return console.warn("⚠️ Backend API 連線暫時失敗，將在後續重試:",e.message),null;return a(e instanceof Error?e.message:"檢查活躍會話失敗"),console.error("❌ 檢查活躍會話失敗:",e),null}finally{n(!1)}},[i]),l=(0,o.useCallback)(async(e,s)=>{n(!0),i();try{let n=await v.createSession({title:e,type:"note_only",content:s});return t(n),console.log("✅ 純筆記會話建立成功:",n),n}catch(e){var r,o,c;if(m.A.isAxiosError(e)&&(null===(r=e.response)||void 0===r?void 0:r.status)===409)return a("檢測到活躍會話衝突，請重新整理頁面後再試"),console.error("❌ 會話衝突錯誤 (409):",(null===(c=e.response)||void 0===c?void 0:null===(o=c.data)||void 0===o?void 0:o.detail)||e.message),null;return a(e instanceof Error?e.message:"建立會話失敗"),console.error("❌ 建立純筆記會話失敗:",e),null}finally{n(!1)}},[i]),u=(0,o.useCallback)(async(e,s)=>{n(!0),i();try{let n=await v.createSession({title:e,type:"recording",content:s});return t(n),console.log("✅ 錄音會話建立成功:",n),n}catch(e){var r,o,c;if(m.A.isAxiosError(e)&&(null===(r=e.response)||void 0===r?void 0:r.status)===409)return a("檢測到活躍會話衝突，請重新整理頁面後再試"),console.error("❌ 會話衝突錯誤 (409):",(null===(c=e.response)||void 0===c?void 0:null===(o=c.data)||void 0===o?void 0:o.detail)||e.message),null;return a(e instanceof Error?e.message:"建立錄音會話失敗"),console.error("❌ 建立錄音會話失敗:",e),null}finally{n(!1)}},[i]),d=(0,o.useCallback)(async()=>{if(!e)return a("沒有活躍的會話可以升級"),null;if("recording"===e.type)return console.log("\uD83D\uDD04 會話已經是錄音模式"),e;n(!0),i();try{let s=await v.upgradeToRecording(e.id);return t(s),console.log("✅ 會話升級為錄音模式成功:",s),s}catch(e){return a(e instanceof Error?e.message:"升級會話失敗"),console.error("❌ 升級會話失敗:",e),null}finally{n(!1)}},[e,i]),g=(0,o.useCallback)(async()=>{if(!e){console.log("\uD83D\uDD04 沒有活躍的會話需要完成");return}n(!0),i();try{await v.finishSession(e.id),console.log("✅ 會話完成成功:",e.id),t(e=>e?{...e,status:"completed"}:null)}catch(e){a(e instanceof Error?e.message:"完成會話失敗"),console.error("❌ 完成會話失敗:",e)}finally{n(!1)}},[e,i]),h=(0,o.useCallback)(async()=>{if(!e){console.log("\uD83D\uDD04 沒有活躍的會話需要刪除");return}n(!0),i();try{await v.deleteSession(e.id),console.log("✅ 會話刪除成功:",e.id),t(null)}catch(e){a(e instanceof Error?e.message:"刪除會話失敗"),console.error("❌ 刪除會話失敗:",e)}finally{n(!1)}},[e,i]),p=(0,o.useCallback)(()=>{t(null),a(null),console.log("\uD83D\uDD04 會話已清除")},[]);return(0,o.useMemo)(()=>({currentSession:e,isLoading:s,error:r,createNoteSession:l,createRecordingSession:u,upgradeToRecording:d,finishSession:g,deleteSession:h,clearSession:p,checkActiveSession:c}),[e,s,r,l,u,d,g,h,p,c])}(),c=function(){let[e,t]=(0,o.useState)(!1),[s,n]=(0,o.useState)(0),[r,a]=(0,o.useState)([]),[i,c]=(0,o.useState)(!1),[l,u]=(0,o.useState)(null),d=(0,o.useRef)(null),g=(0,o.useRef)(null),h=(0,o.useRef)(null),p=(0,o.useRef)(null),m=(0,o.useRef)(null),f=(0,o.useRef)([]),v=(0,o.useRef)(new Map),b=(0,o.useCallback)(()=>{p.current&&(clearInterval(p.current),p.current=null)},[]),x=(0,o.useCallback)(()=>{m.current&&(clearInterval(m.current),m.current=null)},[]),S=(0,o.useCallback)(e=>{x(),m.current=setInterval(()=>{e.isConnected&&e.send(JSON.stringify({type:"heartbeat",timestamp:Date.now()}))},3e4)},[x]),w=(0,o.useCallback)(()=>{b(),n(0),p.current=setInterval(()=>{n(e=>e+1)},1e3)},[b]),C=(0,o.useCallback)(e=>{var t;if(console.log("\uD83D\uDCDD [useRecording] 收到逐字稿訊息:",{type:e.type,text:e.text,textLength:(null===(t=e.text)||void 0===t?void 0:t.length)||0,start_time:e.start_time,end_time:e.end_time,start_sequence:e.start_sequence,confidence:e.confidence,sessionId:h.current,timestamp:new Date().toISOString()}),"transcript_complete"===e.type||"transcription_complete"===e.message){console.log("✅ [useRecording] 逐字稿轉錄完成，設定 transcriptCompleted=true"),c(!0);return}if("transcript_segment"!==e.type){console.log("⚠️ [useRecording] 跳過非逐字稿片段訊息:",e.type);return}if(!e.text){console.log("⚠️ [useRecording] 跳過空文字逐字稿");return}console.log("\uD83D\uDD04 [useRecording] 開始處理逐字稿片段..."),a(t=>{var s,n,r,o;console.log("\uD83D\uDCCA [useRecording] 合併前狀態:",{existingCount:t.length,newSegmentText:e.text,newSegmentSequence:e.start_sequence,newSegmentTime:e.start_time});let a=null!==(o=null!==(r=e.start_sequence)&&void 0!==r?r:e.timestamp)&&void 0!==o?o:0,i=t.filter(e=>{var t,s;return(null!==(s=null!==(t=e.start_sequence)&&void 0!==t?t:e.timestamp)&&void 0!==s?s:0)!==a}),c=[...i,e].sort((e,t)=>{var s,n,r,o;return(null!==(n=null!==(s=e.start_sequence)&&void 0!==s?s:e.timestamp)&&void 0!==n?n:0)-(null!==(o=null!==(r=t.start_sequence)&&void 0!==r?r:t.timestamp)&&void 0!==o?o:0)});return console.log("\uD83D\uDCCA [useRecording] 合併後狀態:",{newCount:c.length,countChange:c.length-t.length,filteredCount:i.length,isDuplicate:i.length!==t.length,lastSegmentText:(null===(n=c[c.length-1])||void 0===n?void 0:null===(s=n.text)||void 0===s?void 0:s.substring(0,50))+"..."}),console.log("✅ [useRecording] 逐字稿更新完成: ".concat(t.length," → ").concat(c.length," 個片段")),c})},[]),R=(0,o.useCallback)(e=>{console.log("\uD83D\uDCE8 收到 ACK/Missing:",e),e.missing.length>0&&(console.warn("⚠️ 有遺失的音檔切片需要重傳:",e.missing),e.missing.forEach(e=>{var t,s;let n=null!==(t=v.current.get(e))&&void 0!==t?t:0;n<5?(v.current.set(e,n+1),f.current[e]&&(console.log("\uD83D\uDD04 重傳音檔切片 #".concat(e," (第 ").concat(n+1," 次)")),null===(s=d.current)||void 0===s||s.uploadAudioChunk(f.current[e].blob))):console.error("❌ 音檔切片 #".concat(e," 重傳次數已達上限"))}))},[]),T=(0,o.useCallback)(e=>{var t;console.log("\uD83C\uDFB5 收到音檔切片 #".concat(e.sequence,", 大小: ").concat(e.blob.size," bytes")),f.current[e.sequence]=e,(null===(t=d.current)||void 0===t?void 0:t.isConnected)&&d.current.uploadAudioChunk(e.blob)},[]),E=(0,o.useCallback)(async e=>{try{u(null),c(!1),h.current=e,console.log("\uD83C\uDFA4 [useRecording] 開始錄音流程:",{sessionId:e}),console.log("\uD83C\uDFA4 [useRecording] 步驟 1: 初始化音檔錄製器");let s=new k({chunkInterval:12e3,mimeType:"audio/webm;codecs=opus"});g.current=s,f.current=[],v.current.clear(),s.onChunk(T),s.onError(e=>{console.error("❌ AudioRecorder 錯誤:",e),u(e.message)}),console.log("\uD83C\uDFA4 [useRecording] 步驟 2: 初始化音訊權限"),await s.initialize(),console.log("\uD83C\uDFA4 [useRecording] 步驟 3: 建立 WebSocket 連線"),console.log("\uD83D\uDD0C [useRecording] 建立音檔上傳 WebSocket");let n=new y(e);if(await n.connect(),n.onAckMissing(R),d.current=n,console.log("\uD83D\uDD0C [useRecording] 建立逐字稿接收 WebSocket"),await D.connect(e),D.addListener(e,C),console.log("\uD83C\uDFA4 [useRecording] 步驟 4: 驗證連線狀態"),!n.isConnected)throw Error("音檔上傳 WebSocket 連線失敗");if(!D.isConnected(e))throw Error("逐字稿接收 WebSocket 連線失敗");console.log("✅ [useRecording] 所有 WebSocket 連線已建立"),console.log("\uD83C\uDFA4 [useRecording] 步驟 5: 啟動心跳機制"),S(n),console.log("\uD83C\uDFA4 [useRecording] 步驟 6: 開始錄音"),t(!0),console.log("\uD83C\uDFA4 [useRecording] 錄音狀態已設置為 true"),await s.startRecording(),w(),console.log("✅ [useRecording] 錄音開始成功，Session ID:",e)}catch(e){u(e instanceof Error?e.message:"開始錄音失敗"),console.error("❌ [useRecording] 開始錄音失敗:",e),g.current&&g.current.stopRecording(),d.current&&(d.current.disconnect(),d.current=null),h.current&&D.removeListener(h.current,C)}},[T,R,C,w,S]),N=(0,o.useCallback)(()=>{try{g.current&&g.current.stopRecording(),d.current&&(d.current.disconnect(),d.current=null),t(!1),b(),x(),console.log("✅ 錄音停止，等待轉錄完成")}catch(e){console.error("❌ 停止錄音失敗:",e),u("停止錄音時發生錯誤")}},[b,x]),_=(0,o.useCallback)(()=>{a([]),c(!1),console.log("\uD83D\uDD04 逐字稿已清除")},[]);return(0,o.useEffect)(()=>()=>{h.current&&D.removeListener(h.current,C),b(),x(),d.current&&d.current.disconnect(),g.current&&g.current.stopRecording()},[b,x,C]),{isRecording:e,recordingTime:s,transcripts:r,transcriptCompleted:i,error:l,startRecording:E,stopRecording:N,clearTranscripts:_}}(),l=function(){let[e,t]=(0,o.useState)(""),[s,n]=(0,o.useState)(null),[r,a]=(0,o.useState)(!1),[i,c]=(0,o.useState)(null),l=(0,o.useRef)(null),u=(0,o.useRef)(""),d=(0,o.useRef)(null),g=function(e){let[t,s]=(0,o.useState)({title:"",content:""}),[n,r]=(0,o.useState)(!1),[a,i]=(0,o.useState)(null),c=(0,o.useRef)(null),l=(0,o.useRef)(e);(0,o.useEffect)(()=>{l.current=e},[e]);let u=(0,o.useCallback)(()=>{c.current&&(clearTimeout(c.current),c.current=null)},[]),d=(0,o.useCallback)(()=>{try{let e=localStorage.getItem(E);if(!e)return r(!1),null;let t=JSON.parse(e),n={title:t.title||"",content:t.content||""},o=t.timestamp?new Date(t.timestamp):new Date,a=t.sessionId;if(l.current&&a!==l.current)return console.log("\uD83D\uDCDD 草稿屬於其他會話，不載入"),null;return s(n),r(!!(n.title.trim()||n.content.trim())),i(o),console.log("\uD83D\uDCD6 草稿已從本地載入"),n}catch(e){return console.error("❌ 載入草稿失敗:",e),null}},[]),g=(0,o.useCallback)(e=>{let n=new Date,o={...t,...e};if(!o.title.trim()&&!o.content.trim()){h();return}let a={...o,timestamp:n.toISOString(),sessionId:l.current||null};try{localStorage.setItem(E,JSON.stringify(a)),s(o),r(!0),i(n),console.log("\uD83D\uDCBE 草稿已儲存到本地:",o)}catch(e){console.error("❌ 儲存草稿失敗:",e)}},[t]),h=(0,o.useCallback)(()=>{u();try{localStorage.removeItem(E),s({title:"",content:""}),r(!1),i(null),console.log("\uD83D\uDDD1️ 草稿已清除")}catch(e){console.error("❌ 清除草稿失敗:",e)}},[u]),p=(0,o.useCallback)(e=>!!a&&!!n&&a>e,[a,n]),m=(0,o.useCallback)(e=>{u(),c.current=setTimeout(()=>{g(e)},500)},[g,u]);return(0,o.useEffect)(()=>{d()},[d]),(0,o.useEffect)(()=>()=>{u()},[u]),(0,o.useMemo)(()=>({draft:t,hasDraft:n,lastDraftTime:a,saveDraft:m,loadDraft:d,clearDraft:h,isDraftNewer:p}),[t,n,a,m,d,h,p])}(d.current||void 0),h=(0,o.useCallback)(()=>{l.current&&(clearTimeout(l.current),l.current=null)},[]),p=(0,o.useCallback)(async(e,t)=>{if(t.trim()&&t!==u.current){a(!0),c(null);try{let s={content:t,client_ts:new Date().toISOString()};await b.updateNote(e,s),n(new Date),u.current=t,console.log("✅ 筆記儲存成功")}catch(e){c(e instanceof Error?e.message:"儲存筆記失敗"),console.error("❌ 儲存筆記失敗:",e)}finally{a(!1)}}},[]),m=(0,o.useCallback)(async t=>{h(),await p(t,e)},[e,p,h]),f=(0,o.useCallback)(e=>{t(e),g.saveDraft(e),d.current&&(h(),l.current=setTimeout(()=>{p(d.current,e)},1e4))},[p,h,g]),v=(0,o.useCallback)(async e=>{d.current=e,c(null);try{let s=await b.getNote(e),r=s.content,o=new Date(s.updated_at);g.hasDraft&&g.isDraftNewer(o)?(console.log("⚠️ 發現較新的本地草稿，使用草稿內容"),t(g.draftContent),u.current=g.draftContent):(t(r),u.current=r,n(o),g.clearDraft()),console.log("✅ 筆記載入成功")}catch(s){let e=s instanceof Error?s.message:"載入筆記失敗";c(e),console.error("❌ 載入筆記失敗:",s),(e.includes("404")||e.includes("not found"))&&(g.hasDraft?(console.log("\uD83D\uDCDD 使用本地草稿內容"),t(g.draftContent)):t(""),u.current="",console.log("\uD83D\uDD04 初始化空筆記"))}},[g]),x=(0,o.useCallback)(()=>{h(),t(""),n(null),c(null),u.current="",d.current=null,g.clearDraft(),console.log("\uD83D\uDD04 筆記已清除")},[h,g]),S=(0,o.useCallback)(()=>{let e=g.loadDraft();e&&(t(e),console.log("\uD83D\uDD04 已還原本地草稿"))},[g]);return(0,o.useEffect)(()=>()=>{h()},[h]),(0,o.useMemo)(()=>({noteContent:e,lastSaved:s,isSaving:r,error:i,updateNote:f,saveNote:m,loadNote:v,clearNote:x,hasDraft:g.hasDraft,lastDraftTime:g.lastDraftTime,restoreDraft:S,clearDraft:g.clearDraft}),[e,s,r,i,f,m,v,x,g.hasDraft,g.lastDraftTime,S,g.clearDraft])}(),u=function(){let[e,t]=(0,o.useState)([]),[s,n]=(0,o.useState)(!1),[r,a]=(0,o.useState)(!1),[i,c]=(0,o.useState)(null),[l,u]=(0,o.useState)(!0),d=(0,o.useRef)(null),g=(0,o.useRef)(null),h=(0,o.useCallback)(s=>{var n;if(console.log("\uD83D\uDCDD [useTranscript] 收到逐字稿訊息:",{type:s.type,text:s.text,textLength:(null===(n=s.text)||void 0===n?void 0:n.length)||0,start_time:s.start_time,end_time:s.end_time,confidence:s.confidence,sessionId:g.current,currentTranscriptCount:e.length,timestamp:new Date().toISOString()}),"transcript_complete"===s.type||"transcription_complete"===s.message){console.log("✅ [useTranscript] 逐字稿轉錄完成，設定 isCompleted=true"),a(!0);return}if("error"===s.type||"transcription_error"===s.type){console.error("\uD83D\uDEA8 [useTranscript] 收到轉錄錯誤:",s),c(s.error_message||s.details||"轉錄過程中發生錯誤");return}if("transcript_segment"!==s.type){console.log("⚠️ [useTranscript] 跳過非逐字稿片段訊息:",s.type);return}if(!s.text){console.log("⚠️ [useTranscript] 跳過空文字逐字稿");return}console.log("\uD83D\uDD04 [useTranscript] 開始處理逐字稿片段..."),t(e=>{var t,n;console.log("\uD83D\uDCCA [useTranscript] 合併前狀態:",{existingCount:e.length,newSegmentText:s.text,newSegmentTime:s.start_time});let r=p(e,s);return console.log("\uD83D\uDCCA [useTranscript] 合併後狀態:",{newCount:r.length,countChange:r.length-e.length,lastSegmentText:(null===(n=r[r.length-1])||void 0===n?void 0:null===(t=n.text)||void 0===t?void 0:t.substring(0,50))+"..."}),console.log("✅ [useTranscript] 逐字稿更新完成: ".concat(e.length," → ").concat(r.length," 個片段")),r})},[e.length]),p=(0,o.useCallback)((e,t)=>{if(!t.start_time)return[...e,t];let s=e.length-1,n=e[s];if(!(n&&n.end_time&&1>=Math.abs(t.start_time-n.end_time)))return[...e,t];{let r={...n,text:(n.text||"")+" "+(t.text||""),end_time:t.end_time||n.end_time,end_sequence:t.end_sequence||n.end_sequence};return[...e.slice(0,s),r]}},[]),m=(0,o.useCallback)(()=>{d.current&&l&&(d.current.scrollTop=d.current.scrollHeight)},[l]),f=(0,o.useCallback)(e=>{let t=e.target;if(!t)return;let{scrollTop:s,scrollHeight:n,clientHeight:r}=t,o=n-s-r;o>60?u(!1):o<=10&&u(!0)},[]),v=(0,o.useCallback)(e=>{d.current&&d.current.removeEventListener("scroll",f),d.current=e,e&&e.addEventListener("scroll",f)},[f]),b=(0,o.useCallback)(()=>{u(!0),m()},[m]),x=(0,o.useCallback)(()=>{u(!1)},[]),S=(0,o.useCallback)(async e=>{try{c(null),a(!1),g.current&&D.removeListener(g.current,h),await D.connect(e),D.addListener(e,h),g.current=e,n(D.isConnected(e)),console.log("✅ use-transcript 連接成功，Session ID:",e)}catch(e){c(e instanceof Error?e.message:"連接逐字稿服務失敗"),n(!1),console.error("❌ use-transcript 連接失敗:",e)}},[h]),y=(0,o.useCallback)(()=>{g.current&&(D.removeListener(g.current,h),g.current=null),n(!1),console.log("\uD83D\uDD0C use-transcript 斷開連接")},[h]),w=(0,o.useCallback)(()=>{t([]),a(!1),console.log("\uD83D\uDD04 use-transcript 逐字稿已清除")},[]);return(0,o.useEffect)(()=>{e.length>0&&m()},[e,m]),(0,o.useEffect)(()=>()=>{g.current&&D.removeListener(g.current,h),d.current&&d.current.removeEventListener("scroll",f)},[h,f]),{transcripts:e,isConnected:s,isCompleted:r,error:i,connect:S,disconnect:y,clearTranscripts:w,autoScrollEnabled:l,enableAutoScroll:b,disableAutoScroll:x,scrollToLatest:m,setScrollContainer:v}}(),{toast:d}=function(){let[e,t]=o.useState(I);return o.useEffect(()=>(A.push(t),()=>{let e=A.indexOf(t);e>-1&&A.splice(e,1)}),[e]),{...e,toast:O,dismiss:e=>L({type:"DISMISS_TOAST",toastId:e})}}();(0,o.useEffect)(()=>{let s=i.currentSession;if(console.log("\uD83D\uDD04 [狀態同步] useEffect 觸發:",{hasActiveSession:!!s,sessionId:null==s?void 0:s.id,sessionStatus:null==s?void 0:s.status,sessionType:null==s?void 0:s.type,isRecording:c.isRecording,transcriptCount:u.transcripts.length,recordingTranscriptCount:c.transcripts.length,currentAppState:e.state}),s){let n=c.transcripts.length>0;console.log("\uD83D\uDD04 [狀態同步] 計算 transcriptsPresent (統一路徑):",{recordingTranscriptCount:c.transcripts.length,transcriptsPresent:n,note:"已移除 transcript.transcripts 避免雙重管理"});let r=q(s.status,s.type,c.isRecording,n);console.log("\uD83D\uDD04 [狀態同步] 狀態變化: ".concat(e.state," → ").concat(r)),t(e=>({...e,state:r}))}},[i.currentSession,c.isRecording,c.transcripts.length,e.state]),(0,o.useEffect)(()=>{let e=!0;return(async()=>{console.log("\uD83D\uDE80 初始化應用狀態..."),n(!0);try{let s=await i.checkActiveSession();if(!e)return;if(s)await l.loadNote(s.id);else{let e=localStorage.getItem("draft_note");e&&(t(t=>({...t,editorContent:e})),console.log("\uD83D\uDCDD 載入本地草稿"))}}catch(s){if(!e)return;if(s instanceof Error&&s.message.includes("Network Error")){console.warn("⚠️ 初始化時 Backend 連線失敗，使用離線模式:",s.message);let e=localStorage.getItem("draft_note");e&&(t(t=>({...t,editorContent:e})),console.log("\uD83D\uDCDD 離線模式：載入本地草稿"))}else console.error("❌ 初始化失敗:",s),a(s instanceof Error?s.message:"初始化失敗")}finally{e&&n(!1)}})(),()=>{e=!1}},[]),(0,o.useEffect)(()=>{t(e=>({...e,isRecording:c.isRecording,recordingTime:c.recordingTime}))},[c.isRecording,c.recordingTime]),(0,o.useEffect)(()=>{t(e=>({...e,editorContent:l.noteContent}))},[l.noteContent]),(0,o.useEffect)(()=>{var e,s;console.log("\uD83D\uDCDD [逐字稿更新] useEffect 觸發:",{recordingTranscriptCount:c.transcripts.length,note:"統一使用 recording.transcripts，避免雙重管理"});let n=c.transcripts.map(e=>{var t,s;let n=null!==(t=e.start_time)&&void 0!==t?t:0,r=Math.floor(n/60),o=Math.floor(n%60);return{time:"".concat(r.toString().padStart(2,"0"),":").concat(o.toString().padStart(2,"0")),text:null!==(s=e.text)&&void 0!==s?s:""}});console.log("\uD83D\uDCDD [逐字稿更新] 轉換完成:",{entriesCount:n.length,firstEntry:(null===(s=n[0])||void 0===s?void 0:null===(e=s.text)||void 0===e?void 0:e.substring(0,30))+"..."}),t(e=>({...e,transcriptEntries:n}))},[c.transcripts]),(0,o.useEffect)(()=>{u.isCompleted&&"processing"===e.state&&(t(e=>({...e,state:"finished"})),i.currentSession&&i.finishSession().catch(console.error))},[u.isCompleted,e.state,i.currentSession,i.finishSession]),(0,o.useEffect)(()=>{let s=c.error,n=u.error;if(s||n){var r;console.log("\uD83D\uDEA8 [錯誤處理] 檢測到錯誤:",{recordingError:s,transcriptError:n,currentState:e.state,sessionId:null===(r=i.currentSession)||void 0===r?void 0:r.id}),("recording_waiting"===e.state||"recording_active"===e.state)&&(console.log("\uD83D\uDEA8 [錯誤處理] 錄音狀態錯誤，停止錄音並回到預設狀態"),c.stopRecording(),u.disconnect(),t(e=>({...e,state:"default"})),d({title:"錄音錯誤",description:s||n||"錄音或轉錄過程中發生錯誤",variant:"destructive"})),"processing"===e.state&&(console.log("\uD83D\uDEA8 [錯誤處理] 處理狀態錯誤，回到預設狀態"),t(e=>({...e,state:"default"})),d({title:"處理錯誤",description:n||s||"處理轉錄過程中發生錯誤",variant:"destructive"}))}},[c.error,u.error,e.state,i.currentSession,c,u,d]);let g=(0,o.useCallback)(async e=>{n(!0),a(null);try{let t=await i.createNoteSession(e);t&&(await l.loadNote(t.id),localStorage.removeItem("draft_note"),console.log("✅ 純筆記會話建立成功"),d({title:"筆記會話已建立",description:'會話 "'.concat(e,'" 建立成功')}))}catch(t){if(t instanceof Error&&t.message.includes("檢測到活躍會話衝突")){console.error("\uD83C\uDFA4 startRecording: 會話衝突錯誤:",t.message),a("偵測到會話衝突，請重新整理頁面後再試"),d({title:"會話衝突",description:"目前已有活躍會話，請重新整理頁面後再試，或等待當前會話結束",variant:"destructive"});return}let e=t instanceof Error?t.message:"開始錄音失敗";console.error("\uD83C\uDFA4 startRecording: 流程中發生錯誤:",e),a(e),d({title:"錄音失敗",description:e,variant:"destructive"})}finally{n(!1),console.log("\uD83C\uDFA4 startRecording: 流程結束")}},[i,c,u,e.editorContent,d]),h=(0,o.useCallback)(async t=>{n(!0),a(null);try{let s=await i.createRecordingSession(t,e.editorContent);s&&(await l.loadNote(s.id),localStorage.removeItem("draft_note"),console.log("✅ 錄音會話建立成功"),d({title:"錄音會話已建立",description:'會話 "'.concat(t,'" 建立成功')}))}catch(t){if(t instanceof Error&&t.message.includes("檢測到活躍會話衝突")){console.error("\uD83C\uDFA4 createRecordingSession: 會話衝突錯誤:",t.message),a("偵測到會話衝突，請重新整理頁面後再試"),d({title:"會話衝突",description:"目前已有活躍會話，請重新整理頁面後再試，或等待當前會話結束",variant:"destructive"});return}let e=t instanceof Error?t.message:"建立錄音會話失敗";a(e),console.error("❌ 建立錄音會話失敗:",t),d({title:"建立失敗",description:e,variant:"destructive"})}finally{n(!1)}},[i,l,d,e.editorContent]),p=(0,o.useCallback)(async t=>{console.log("\uD83C\uDFA4 startRecording: 流程開始"),n(!0);try{var s;console.log("\uD83C\uDFA4 startRecording: 檢查活躍會話狀態");let n=await i.checkActiveSession(),r=n||i.currentSession;if(console.log("\uD83C\uDFA4 startRecording: 會話狀態檢查結果:",{latestActiveSession:null==n?void 0:n.id,currentSession:null===(s=i.currentSession)||void 0===s?void 0:s.id,finalSessionToUse:null==r?void 0:r.id}),n&&!i.currentSession&&console.log("\uD83C\uDFA4 startRecording: 檢測到活躍會話，同步前端狀態"),r){if("note_only"===r.type){console.log("\uD83C\uDFA4 startRecording: 偵測到 note_only session，進行升級");let e=await i.upgradeToRecording();if(!e)throw console.error("\uD83C\uDFA4 startRecording: 升級 session 失敗，回傳值為 null"),Error("無法升級會話");console.log("\uD83C\uDFA4 startRecording: Session 升級成功:",e),r=e}else"recording"===r.type&&console.log("\uD83C\uDFA4 startRecording: 使用現有的錄音會話:",r.id)}else{console.log("\uD83C\uDFA4 startRecording: 沒有 session，建立新的錄音 session");let s=await i.createRecordingSession(t,e.editorContent);if(!s)throw console.error("\uD83C\uDFA4 startRecording: 建立 session 失敗，回傳值為 null"),Error("無法建立新的錄音會話");console.log("\uD83C\uDFA4 startRecording: Session 建立成功:",s),r=s,localStorage.removeItem("draft_note")}console.log("\uD83C\uDFA4 startRecording: 準備呼叫 recording.startRecording"),await c.startRecording(r.id),console.log("\uD83C\uDFA4 startRecording: recording.startRecording 呼叫完畢"),console.log("\uD83C\uDFA4 startRecording: 跳過 transcript.connect，避免雙重監聽器"),console.log("\uD83C\uDFA4 startRecording: 逐字稿將由 useRecording hook 統一管理"),d({title:"錄音開始"})}catch(t){if(t instanceof Error&&t.message.includes("檢測到活躍會話衝突")){console.error("\uD83C\uDFA4 startRecording: 會話衝突錯誤:",t.message),a("偵測到會話衝突，請重新整理頁面後再試"),d({title:"會話衝突",description:"目前已有活躍會話，請重新整理頁面後再試，或等待當前會話結束",variant:"destructive"});return}let e=t instanceof Error?t.message:"開始錄音失敗";console.error("\uD83C\uDFA4 startRecording: 流程中發生錯誤:",e),a(e),d({title:"錄音失敗",description:e,variant:"destructive"})}finally{n(!1),console.log("\uD83C\uDFA4 startRecording: 流程結束")}},[i,c,u,e.editorContent,d]),f=(0,o.useCallback)(async()=>{n(!0),a(null);try{await i.upgradeToRecording()&&(console.log("✅ 會話升級為錄音模式成功"),d({title:"升級成功",description:"會話已升級為錄音模式"}))}catch(t){let e=t instanceof Error?t.message:"升級會話失敗";a(e),console.error("❌ 升級會話失敗:",t),d({title:"升級失敗",description:e,variant:"destructive"})}finally{n(!1)}},[i,d]),x=(0,o.useCallback)(async()=>{n(!0),a(null);try{await c.stopRecording(),u.disconnect(),t(e=>({...e,state:"processing"})),console.log("✅ 錄音停止，開始處理逐字稿"),d({title:"處理中",description:"正在處理錄音內容，請稍候..."})}catch(t){let e=t instanceof Error?t.message:"停止錄音失敗";a(e),console.error("❌ 停止錄音失敗:",t),d({title:"停止失敗",description:e,variant:"destructive"})}finally{n(!1)}},[c,d]),S=(0,o.useCallback)(async()=>{n(!0),a(null);try{await i.finishSession(),console.log("✅ 會話完成"),d({title:"會話完成",description:"您可以匯出筆記或開始新的筆記"})}catch(t){let e=t instanceof Error?t.message:"完成會話失敗";a(e),console.error("❌ 完成會話失敗:",t),d({title:"完成失敗",description:e,variant:"destructive"})}finally{n(!1)}},[i,d]),w=(0,o.useCallback)(async()=>{n(!0),a(null);try{i.currentSession&&(console.log("\uD83D\uDDD1️ 刪除當前活躍會話:",i.currentSession.id),await i.deleteSession(),console.log("✅ 會話刪除成功")),t({state:"default",transcriptEntries:[],editorContent:"",isRecording:!1,recordingTime:0}),c.clearTranscripts(),u.clearTranscripts(),l.clearNote(),localStorage.removeItem("draft_note"),console.log("\uD83D\uDD04 已開始新筆記"),d({title:"新筆記",description:"已清空內容，可以開始新的筆記"})}catch(t){let e=t instanceof Error?t.message:"開始新筆記失敗";a(e),console.error("❌ 開始新筆記失敗:",t),d({title:"操作失敗",description:e,variant:"destructive"})}finally{n(!1)}},[i,c,u,l,d]);return{appData:e,isLoading:s,error:r,createNoteSession:g,createRecordingSession:h,upgradeToRecording:f,finishSession:S,newNote:w,startRecording:p,stopRecording:x,saveLocalDraft:(0,o.useCallback)(e=>{!i.currentSession&&e.trim()&&localStorage.setItem("draft_note",e)},[i.currentSession]),session:i.currentSession,sessionLoading:i.isLoading,sessionError:i.error,recordingError:c.error,transcriptConnected:u.isConnected,transcriptError:u.error,transcriptAutoScroll:u.autoScrollEnabled,enableAutoScroll:u.enableAutoScroll,disableAutoScroll:u.disableAutoScroll,scrollToLatest:u.scrollToLatest}}(),[d,f]=(0,o.useState)("");console.log("[DEBUG] appData.state:",e.state),console.log("[DEBUG] appData.isRecording:",e.isRecording),u?console.log("[DEBUG] session.status:",u.status,"session.type:",u.type):console.log("[DEBUG] session: null");let x=(0,o.useMemo)(()=>({spellChecker:!1,placeholder:"Start writing your notes...",status:!1,toolbar:["bold","italic","strikethrough","|","heading-1","heading-2","heading-3","|","quote","unordered-list","ordered-list","|","link","image","table","|","preview","side-by-side","fullscreen"],autofocus:!0,tabSize:2}),[]);return(0,n.jsxs)("div",{className:"h-screen bg-background flex flex-col",suppressHydrationWarning:!0,children:[(0,n.jsxs)("div",{className:"bg-background border-b border-border px-6 flex-shrink-0 w-full h-20 flex justify-between items-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-semibold text-foreground",children:"Study Scriber"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[("default"===e.state&&!!u||"recording_waiting"===e.state||"recording_active"===e.state||"finished"===e.state)&&(0,n.jsxs)(g,{variant:"outline",onClick:i,size:"sm",className:"px-4 h-8 flex items-center gap-2",children:[(0,n.jsx)(h.A,{className:"w-4 h-4"}),"New note"]}),"finished"===e.state&&(0,n.jsxs)(g,{onClick:()=>console.log("Export functionality"),size:"sm",className:"px-4 h-8 flex items-center gap-2",children:[(0,n.jsx)(p.A,{className:"w-4 h-4"}),"Export"]})]})]}),(0,n.jsxs)("div",{className:"flex h-[calc(100vh-80px)]",suppressHydrationWarning:!0,children:[(0,n.jsx)("div",{className:"flex-1 bg-background border-r border-border h-full",children:(0,n.jsxs)("div",{className:"h-full p-6 flex flex-col gap-4",children:[(0,n.jsx)(l,{placeholder:"請輸入標題...",className:"text-lg font-semibold",value:d,onChange:e=>f(e.target.value),disabled:"processing"===e.state||"finished"===e.state||e.isRecording}),(0,n.jsx)("div",{className:"h-full editor-container flex-grow",children:(0,n.jsx)(ee,{options:x,value:e.editorContent,onChange:c})})]})}),(0,n.jsx)("div",{className:"w-80 bg-background flex-shrink-0 h-full",children:(()=>{switch(e.state){case"default":return(0,n.jsx)(W,{onStartRecording:()=>{console.log("\uD83D\uDCF1 StudyScriber: 準備調用 startRecording，標題:",d),r(d)}});case"recording_active":return(0,n.jsx)(X,{transcriptEntries:e.transcriptEntries,recordingTime:e.recordingTime,onStopRecording:a});case"recording_waiting":return(0,n.jsx)(X,{transcriptEntries:[],recordingTime:e.recordingTime,onStopRecording:a});case"processing":return(0,n.jsx)($,{});case"finished":return(0,n.jsx)(Z,{transcriptEntries:e.transcriptEntries,onExport:()=>{console.log("Export functionality not implemented yet")},onToLatest:()=>{console.log("To Latest functionality not implemented yet")}});default:return(0,n.jsx)(W,{onStartRecording:()=>{console.log("\uD83D\uDCF1 StudyScriber: 準備調用 startRecording (default)，標題:",d),r(d)}})}})()})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[294,223,647,303,358],()=>t(1913)),_N_E=e.O()}]);