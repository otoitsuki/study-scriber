# StudyScriber æ¸¬è©¦å¥—ä»¶

## ğŸ¯ ã€Œä¸€æ®µä¸€è½‰ã€æ¶æ§‹æ¸¬è©¦

æœ¬æ¸¬è©¦å¥—ä»¶å°ˆç‚º StudyScriber çš„ã€Œä¸€æ®µä¸€è½‰ã€è½‰éŒ„æ¶æ§‹è¨­è¨ˆï¼Œç¢ºä¿ç³»çµ±çš„ç©©å®šæ€§å’Œæ€§èƒ½ã€‚

### ğŸ“‹ æ¸¬è©¦çµæ§‹

```
tests/
â”œâ”€â”€ unit/                           # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ test_transcription_logic.py # è½‰éŒ„é‚è¼¯æ ¸å¿ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ test_azure_openai_v2.py     # Azure OpenAI æœå‹™æ¸¬è©¦
â”‚   â””â”€â”€ test_upload_audio.py        # éŸ³æª”ä¸Šå‚³æ¸¬è©¦
â”œâ”€â”€ integration/                    # æ•´åˆæ¸¬è©¦
â”‚   â””â”€â”€ test_one_chunk_one_transcription.py  # å®Œæ•´æµç¨‹æ¸¬è©¦
â”œâ”€â”€ fixtures/                       # æ¸¬è©¦è³‡æ–™
â”œâ”€â”€ conftest.py                     # pytest é…ç½®
â””â”€â”€ test_report.py                  # æ¸¬è©¦å ±å‘Šç”Ÿæˆå™¨
```

### ğŸ§ª åŸ·è¡Œæ¸¬è©¦

#### ä½¿ç”¨ Makefileï¼ˆæ¨è–¦ï¼‰

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
make help

# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
make test

# åŸ·è¡Œå–®å…ƒæ¸¬è©¦
make test-unit

# ç”Ÿæˆè©³ç´°æ¸¬è©¦å ±å‘Š
make test-report

# é©—è­‰æ¶æ§‹å®Œæ•´æ€§
make verify-architecture
```

#### ç›´æ¥ä½¿ç”¨ pytest

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
uv run pytest tests/ -v

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ
uv run pytest tests/unit/test_transcription_logic.py -v

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦
uv run pytest tests/unit/test_transcription_logic.py::TestTranscriptionLogic::test_twelve_second_chunks -v
```

### ğŸ—ï¸ æ¶æ§‹æ¸¬è©¦é‡é»

#### 1. æ ¸å¿ƒé‚è¼¯æ¸¬è©¦
- âœ… **12ç§’åˆ‡ç‰‡è™•ç†** - é©—è­‰å›ºå®šé–“éš”åˆ‡ç‰‡
- âœ… **ä½å»¶é²è™•ç†** - ç¢ºä¿è™•ç†æ™‚é–“ < 500ms
- âœ… **ä¸¦è¡Œè™•ç†** - å¤šåˆ‡ç‰‡åŒæ™‚è™•ç†
- âœ… **é †åºè™•ç†** - é€£çºŒåˆ‡ç‰‡è™•ç†
- âœ… **éŒ¯èª¤è™•ç†** - ç„¡æ•ˆè³‡æ–™è™•ç†
- âœ… **é‡è¤‡åˆ‡ç‰‡è™•ç†** - é˜²æ­¢é‡è¤‡è™•ç†

#### 2. è³‡æ–™æ ¼å¼æ¸¬è©¦
- âœ… **WebM é©—è­‰** - ç°¡åŒ–é©—è­‰é‚è¼¯
- âœ… **WAV è½‰æ›** - FFmpeg è½‰æ›æ¸¬è©¦
- âœ… **è½‰éŒ„åŠŸèƒ½** - æ¨¡æ“¬ API å‘¼å«

#### 3. æ€§èƒ½æ¸¬è©¦
- âœ… **è™•ç†æ™‚é–“** - ç«¯åˆ°ç«¯å»¶é²æ¸¬é‡
- âœ… **ä½µç™¼è™•ç†** - å¤šä»»å‹™ä¸¦è¡Œèƒ½åŠ›
- âœ… **è³‡æºæ¸…ç†** - ä»»å‹™å®Œæˆå¾Œæ¸…ç†

### ğŸ“Š æ¸¬è©¦å ±å‘Š

åŸ·è¡Œ `make test-report` æœƒç”Ÿæˆè©³ç´°çš„æ¸¬è©¦å ±å‘Šï¼ŒåŒ…å«ï¼š

- ğŸ“ˆ æ¸¬è©¦é€šéç‡çµ±è¨ˆ
- ğŸ—ï¸ æ¶æ§‹é©—è­‰ç‹€æ…‹
- âš¡ æ€§èƒ½æŒ‡æ¨™è©•ä¼°
- ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè­°

### ğŸ”§ æ¶æ§‹é©—è­‰

ã€Œä¸€æ®µä¸€è½‰ã€æ¶æ§‹çš„é—œéµç‰¹æ€§ï¼š

| ç‰¹æ€§ | èˆŠæ–¹å¼ | æ–°æ–¹å¼ |
|------|--------|--------|
| **è™•ç†æµç¨‹** | æ”¶é›†â†’åˆä½µâ†’è½‰éŒ„ | ç›´æ¥è½‰éŒ„ |
| **å»¶é²** | ç´¯ç©å»¶é² | **å¹¾ç™¾æ¯«ç§’** |
| **åˆ‡ç‰‡é–“éš”** | ä¸å®š | **12ç§’å›ºå®š** |
| **éŒ¯èª¤è™•ç†** | å½±éŸ¿æ•´æ‰¹ | **å–®å€‹é‡è©¦** |
| **ç¨‹å¼è¤‡é›œåº¦** | é«˜ | **ç°¡æ½”** |

### ğŸš€ è³‡æ–™æµ

```
å‰ç«¯éŒ„éŸ³ (12s) â†’ WebM chunk â†’ WebSocket ä¸Šå‚³ 
                                    â†“
                              FFmpeg stdin 
                                    â†“
                              WAV bytes 
                                    â†“
                              Whisper API
                                    â†“
                              é€å­—ç¨¿çµæœ â† WebSocket æ¨é€
```

### ğŸ› ï¸ æŠ€è¡“ç´°ç¯€

#### FFmpeg åƒæ•¸å„ªåŒ–
```bash
ffmpeg -fflags +genpts -i pipe:0 -ac 1 -ar 16000 -f wav -y pipe:1
```
- `-fflags +genpts`: è™•ç†ä¸å®Œæ•´çš„æµå¼è³‡æ–™
- `-ac 1`: å–®è²é“
- `-ar 16000`: 16kHz æ¡æ¨£ç‡
- `-y`: è¦†è“‹è¼¸å‡º

#### å‰ç«¯é…ç½®
```typescript
const config = {
    chunkInterval: 12000,  // 12ç§’åˆ‡ç‰‡
    mimeType: 'audio/webm;codecs=opus'
};
```

### ğŸ› æ•…éšœæ’é™¤

#### æ¸¬è©¦å¤±æ•—å¸¸è¦‹åŸå› 

1. **è³‡æ–™åº«é€£æ¥éŒ¯èª¤**
   - ç¢ºä¿æ¸¬è©¦ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š
   - æª¢æŸ¥ `tests/conftest.py` ä¸­çš„æ¨¡æ“¬é…ç½®

2. **ä¾è³´é …ç›®ç¼ºå¤±**
   ```bash
   uv sync  # å®‰è£ Python ä¾è³´
   ```

3. **FFmpeg æœªå®‰è£**
   ```bash
   # macOS
   brew install ffmpeg
   
   # Ubuntu
   sudo apt install ffmpeg
   ```

#### æ¸¬è©¦ç’°å¢ƒæª¢æŸ¥
```bash
make check-env  # æª¢æŸ¥é–‹ç™¼ç’°å¢ƒ
```

### ğŸ“ æ–°å¢æ¸¬è©¦

#### å–®å…ƒæ¸¬è©¦ç¯„ä¾‹
```python
@pytest.mark.asyncio
async def test_new_feature(service, session_id):
    """æ¸¬è©¦æ–°åŠŸèƒ½"""
    result = await service.new_method(session_id, test_data)
    assert result is not None
    # æ›´å¤šæ–·è¨€...
```

#### æ•´åˆæ¸¬è©¦ç¯„ä¾‹
```python
@pytest.mark.asyncio
async def test_end_to_end_flow():
    """æ¸¬è©¦ç«¯åˆ°ç«¯æµç¨‹"""
    # è¨­å®šæ¸¬è©¦è³‡æ–™
    # åŸ·è¡Œå®Œæ•´æµç¨‹
    # é©—è­‰çµæœ
```

### ğŸ”„ æŒçºŒæ•´åˆ

æ¸¬è©¦æ‡‰è©²åœ¨ä»¥ä¸‹æƒ…æ³åŸ·è¡Œï¼š
- ğŸ”„ æ¯æ¬¡ç¨‹å¼ç¢¼æäº¤å‰
- ğŸš€ éƒ¨ç½²å‰é©—è­‰
- ğŸ“… å®šæœŸå›æ­¸æ¸¬è©¦
- ğŸ› ä¿®å¾© bug å¾Œé©—è­‰

### ğŸ“š ç›¸é—œè³‡æº

- [pytest å®˜æ–¹æ–‡æª”](https://docs.pytest.org/)
- [FastAPI æ¸¬è©¦æŒ‡å—](https://fastapi.tiangolo.com/tutorial/testing/)
- [Azure OpenAI API æ–‡æª”](https://learn.microsoft.com/en-us/azure/ai-services/openai/)
- [WebSocket æ¸¬è©¦æœ€ä½³å¯¦è¸](https://websockets.readthedocs.io/en/stable/) 
