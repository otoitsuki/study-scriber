# StudyScriber 環境變數

# ============================================
# Supabase 資料庫配置 (必須)
# ============================================
DB_MODE=supabase
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_KEY=your-anon-public-key

# ============================================
# 語音轉文字 Provider 設定
# ============================================
# 預設 STT Provider：whisper, gpt4o, gemini, breeze-asr-25
STT_PROVIDER_DEFAULT=breeze-asr-25
DEFAULT_STT_PROVIDER=breeze-asr-25

# 支援的 STT Providers (逗號分隔)
# SUPPORTED_STT_PROVIDERS=whisper,gpt4o,gemini,breeze-asr-25

# ============================================
# Azure OpenAI 服務 (必須)
# ============================================
AZURE_OPENAI_API_KEY=your-api-key
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_API_VERSION=2024-02-01


# ============================================
# Whisper 服務
# ============================================
WHISPER_DEPLOYMENT_NAME=whisper-1
WHISPER_LANGUAGE=zh-TW

# ============================================
# GPT-4o 音頻轉錄服務 (可選)
# ============================================
GPT4O_DEPLOYMENT_NAME=gpt4o
GPT4O_TRANSCRIBE_PROMPT=
GPT4O_MAX_REQUESTS=60

# ============================================
# Google Vertex AI 服務 (Gemini STT - 可選)
# ============================================
# 取消註釋以下設定以啟用 Gemini 2.5 Pro STT
# GEMINI_ENDPOINT=us-central1-aiplatform.googleapis.com
# GEMINI_API_KEY=your-gcp-service-account-key
# GEMINI_PROMPT=請輸出逐字稿：
# GEMINI_MAX_REQUESTS=90


# ============================================
# Azure OpenAI 批次處理設定 (優化為低延遲)
# ============================================

# 批次處理設定 (優化為低延遲)
# 批次大小：2個音檔切片
WHISPER_BATCH_SIZE=2
# 批次超時：3秒 (目標延遲 ≤5秒)
WHISPER_BATCH_TIMEOUT=3

# 效能監控設定
# 啟用效能日誌記錄
ENABLE_PERFORMANCE_LOGGING=true

# ============================================
# Whisper 幻覺過濾設定 (提升轉錄品質)
# ============================================
# 這些參數用於過濾 Azure Whisper API 產生的低品質或幻覺段落
# 使用 verbose_json 格式的回應進行後端自動過濾

# 靜音檢測門檻 - 過濾高靜音機率的段落
# 範圍：0.0-1.0，值越高越嚴格
# 建議值：0.8 (過濾 80% 以上靜音機率的段落)
# 用途：移除「嗯」、「呃」等填充詞和靜音片段
FILTER_NO_SPEECH=0.8

# 置信度過濾門檻 - 過濾低置信度的段落
# 範圍：-5.0 到 0.0，值越高越嚴格
# 建議值：-1.0 (過濾平均對數機率低於 -1.0 的段落)
# 用途：移除模型不確定的轉錄結果
FILTER_LOGPROB=-1.0

# 重複內容檢測門檻 - 過濾高重複比率的段落
# 範圍：1.0+，值越低越嚴格
# 建議值：2.4 (過濾壓縮比大於 2.4 的段落)
# 用途：移除重複文字、迴圈幻覺等內容
FILTER_COMPRESSION=2.4

# ============================================
# 音頻切片與時間戳統一配置 (一處設定，全域套用)
# ============================================
# 音頻切片時長（秒）- 統一控制以下設定：
# - 前端錄音切片間隔
# - 後端音頻處理長度
# - 逐字稿時間戳間隔
# - WebSocket 推送頻率
# 建議值：10-20秒，過短會增加 API 呼叫次數，過長會增加延遲
AUDIO_CHUNK_DURATION_SEC=15

# 音頻切片重疊時間（秒）- 避免切片邊界丟失內容
# 建議值：0-2秒，通常設為 0
AUDIO_CHUNK_OVERLAP_SEC=0

# ============================================
# Cloudflare R2 儲存設定 (音檔暫存)
# ============================================
R2_ACCOUNT_ID=your-r2-account-id
R2_BUCKET_NAME=studyscriber-audio
R2_API_TOKEN=your-r2-api-token

# ============================================
# 應用程式設定 (可選)
# ============================================
DEBUG=false
LOG_LEVEL=INFO
CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000,http://0.0.0.0:3000

# ============================================
# REST API 架構配置
# ============================================
SEGMENT_DURATION=10
UPLOAD_MAX_SIZE=5242880
AUDIO_BITRATE=128000
MIME_TYPE=audio/webm;codecs=opus

# ============================================
# 上傳與重試設定
# ============================================
UPLOAD_TIMEOUT_SEC=30
MAX_RETRIES=3
RETRY_DELAY_SEC=2

# ============================================
# 速率限制設定
# ============================================
USE_SLIDING_WINDOW_RATE_LIMIT=false
SLIDING_WINDOW_MAX_REQUESTS=3
SLIDING_WINDOW_SECONDS=60

# ============================================
# 並發處理優化配置
# ============================================
MAX_CONCURRENT_TRANSCRIPTIONS=3
TRANSCRIPTION_WORKERS_COUNT=3
QUEUE_BACKLOG_THRESHOLD=10
QUEUE_MONITOR_INTERVAL=5
QUEUE_ALERT_COOLDOWN=30

# ============================================
# 隊列系統配置
# ============================================
MAX_QUEUE_SIZE=100
QUEUE_TIMEOUT_SECONDS=300

# ============================================
# HTTP 客戶端超時設定
# ============================================
HTTPX_CONNECT_TIMEOUT=15.0
HTTPX_READ_TIMEOUT=300.0
HTTPX_WRITE_TIMEOUT=60.0
HTTPX_POOL_TIMEOUT=15.0

# ============================================
# 靜音判斷參數
# ============================================
SILENCE_NOISE_DB=-35.0
SILENCE_DURATION_SEC=0.3
